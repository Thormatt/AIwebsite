<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Readiness Assessment - Thor AI Advisory</title>
    <meta name="description" content="Measure your organization's AI maturity across data, technical, business, and cultural dimensions">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-nqVEpFWK/E1sgABLf1pCVLPZhPTVRVrq/K0dGLxj2x2TbZ/FdR8K7TdJz0J1g0Ql" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Chart.js graceful fallback for corporate networks with strict SRI policies
        (function ensureChartLoaded() {
            // Wait for DOM ready, then check if Chart.js loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', ensureChartLoaded);
                return;
            }
            if (!window.Chart) {
                console.warn('Chart.js failed to load with SRI, attempting fallback without integrity check');
                var s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                s.crossOrigin = 'anonymous';
                document.head.appendChild(s);
            }
        })();
    </script>
    <style>
        .assessment-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .assessment-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .assessment-header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .assessment-header p {
            font-size: 1.125rem;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 3rem;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #d4a574 0%, #b8935f 100%);
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .question-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            min-height: 400px;
            display: none;
        }

        .question-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            margin-bottom: 2rem;
        }

        .question-category {
            display: inline-block;
            background: #f3f4f6;
            color: #4b5563;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .question-number {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.25rem;
            color: #2c3e50;
            font-weight: 500;
            line-height: 1.6;
        }

        .options-grid {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .option {
            display: flex;
            align-items: flex-start;
            padding: 1.25rem;
            background: #fafafa;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: #d4a574;
            background: #fffbf5;
        }

        .option.selected {
            border-color: #d4a574;
            background: #fef3e6;
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            margin-right: 1rem;
            flex-shrink: 0;
            margin-top: 2px;
            position: relative;
        }

        .option.selected .option-radio {
            border-color: #d4a574;
        }

        .option.selected .option-radio::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 8px;
            height: 8px;
            background: #d4a574;
            border-radius: 50%;
        }

        .option-content {
            flex: 1;
        }

        .option-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .option-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-prev {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-prev:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .btn-next {
            background: #d4a574;
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: #b8935f;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .results-container.active {
            display: block;
        }

        .score-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .overall-score {
            font-size: 4rem;
            font-weight: 600;
            color: #d4a574;
            margin: 1rem 0;
        }

        .score-label {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        .maturity-level {
            display: inline-block;
            background: rgba(212, 165, 116, 0.2);
            color: #d4a574;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            margin-top: 1rem;
            font-weight: 500;
        }

        .dimension-scores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .dimension-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .dimension-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .dimension-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .dimension-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .dimension-score {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .recommendations {
            background: #fafafa;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .recommendations h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .recommendation-list {
            list-style: none;
            padding: 0;
        }

        .recommendation-list li {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .recommendation-list li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #d4a574;
            font-weight: bold;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: #d4a574;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #b8935f;
        }

        .restart-btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #d4a574;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            margin-top: 1.5rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }

        .restart-btn:hover {
            background: #b8935f;
        }

        /* Radar Chart Container */
        .radar-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .radar-container h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #2c3e50;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            border-color: #d4a574;
            color: #d4a574;
        }

        /* System Card Styles */
        .system-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .system-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            border-bottom: 2px solid #d4a574;
            padding-bottom: 0.5rem;
        }

        .system-card-section {
            margin: 1.5rem 0;
        }

        .system-card-section h4 {
            color: #4b5563;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .system-card-section p {
            color: #6b7280;
            line-height: 1.6;
        }

        /* Control Gap Register */
        .control-gap-register {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .control-gap-register h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .control-item {
            background: #fafafa;
            border-left: 4px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .control-item.critical {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .control-item.high {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .control-item.medium {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .control-id {
            font-weight: 600;
            color: #2c3e50;
        }

        .severity-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .severity-badge.critical {
            background: #ef4444;
            color: white;
        }

        .severity-badge.high {
            background: #f59e0b;
            color: white;
        }

        .severity-badge.medium {
            background: #10b981;
            color: white;
        }

        .control-description {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Roadmap Timeline */
        .roadmap {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .roadmap h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .roadmap-phase {
            margin-bottom: 2rem;
            padding-left: 2rem;
            border-left: 3px solid #d4a574;
        }

        .roadmap-phase h4 {
            color: #d4a574;
            margin-bottom: 0.75rem;
        }

        .roadmap-phase ul {
            list-style: none;
            padding: 0;
        }

        .roadmap-phase li {
            color: #6b7280;
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .roadmap-phase li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #d4a574;
        }

        /* Print Styles */
        @media print {
            .back-link, .restart-btn, .export-buttons, .navigation-buttons, #risk-classifier, #aggregate-output {
                display: none !important;
            }

            #questions, .radar-container, .control-gap-register, .recommendations, .roadmap, .methodology, .system-card, .dimension-scores {
                display: none !important;
            }

            #exec-readout {
                display: block !important;
            }

            .assessment-container {
                max-width: 100%;
                padding: 1rem;
            }

            .score-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            @page {
                margin: 2cm;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Icons -->
    <svg style="display: none;">
        <defs>
            <symbol id="icon-dollar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </symbol>
            <symbol id="icon-file" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </symbol>
            <symbol id="icon-printer" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </symbol>
            <symbol id="icon-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </symbol>
            <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </symbol>
            <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
            </symbol>
            <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18M3 12h18M5.6 5.6l12.8 12.8M5.6 18.4L18.4 5.6"></path>
            </symbol>
            <symbol id="icon-trending" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </symbol>
        </defs>
    </svg>

    <div class="assessment-container">
        <a href="../tools.html" class="back-link">‚Üê Back to Tools</a>

        <div class="assessment-header">
            <h1>AI Readiness Assessment</h1>
            <p>Answer 10 questions to understand your organization's AI maturity and get a personalized roadmap</p>
        </div>

        <!-- Industry Preset Selector -->
        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="color: #d4a574;">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <label for="industry-selector" style="font-weight: 600; color: #1f2937; margin: 0;">Select Your Industry</label>
            </div>
            <select id="industry-selector" onchange="applyIndustryPreset(this.value)" style="width: 100%; padding: 0.875rem; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: #fafafa; transition: all 0.2s; cursor: pointer;">
                <option value="generic">General / Other Industry</option>
                <option value="financial-services">Financial Services</option>
                <option value="healthcare">Healthcare & Life Sciences</option>
                <option value="public-sector">Public Sector & Government</option>
                <option value="retail">Retail & E-Commerce</option>
                <option value="manufacturing">Manufacturing & Industrial</option>
            </select>
            <div id="industry-info" style="margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 6px; font-size: 0.875rem; color: #6b7280;">
                <div><strong>Assessment Focus:</strong> <span id="industry-weights">Balanced across all dimensions</span></div>
                <div style="margin-top: 0.5rem;"><strong>Regulatory Context:</strong> <span id="industry-regs">Baseline compliance: GDPR (if EU), local data protection laws</span></div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <!-- Questions -->
        <div id="questions">
            <!-- Question containers will be generated by JavaScript -->
        </div>

        <!-- Results -->
        <div class="results-container" id="results">
            <!-- Incomplete Alert -->
            <div id="incomplete-alert" role="alert" aria-live="polite" style="display:none; background:#fef2f2; color:#991b1b; border-left:4px solid #ef4444; padding:0.75rem; border-radius:6px; margin:1rem 0;">
                <svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-alert"/></svg>Please answer all questions before viewing results.
            </div>

            <div class="score-card">
                <div class="score-label">Overall AI Readiness Score</div>
                <div class="overall-score" id="overall-score">--</div>
                <div class="maturity-level" id="maturity-level">Calculating...</div>
            </div>

            <!-- Benchmark Indicator -->
            <div id="benchmark-indicator" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <h3 style="margin: 0; color: #1f2937;">Industry Benchmark</h3>
                    <span id="percentile-badge" style="background: #d4a574; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.875rem;">--</span>
                </div>
                <p id="benchmark-description" style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;"></p>
                <div style="position: relative; height: 60px; background: linear-gradient(90deg, #fee2e2 0%, #fef3c7 25%, #fef9c3 50%, #d1fae5 75%, #a7f3d0 100%); border-radius: 8px; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 25%; width: 1px; height: 100%; background: #9ca3af;"></div>
                    <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: #9ca3af;"></div>
                    <div style="position: absolute; top: 0; left: 75%; width: 1px; height: 100%; background: #9ca3af;"></div>
                    <div id="user-marker" style="position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background: #2c3e50; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                    <span>0 (Low)</span>
                    <span id="p25-label">--</span>
                    <span id="p50-label">--</span>
                    <span id="p75-label">--</span>
                    <span>100 (High)</span>
                </div>
            </div>

            <!-- Gate alert (shown when gating logic triggers) -->
            <div id="gate-alert" role="alert" aria-live="polite" style="display: none;"></div>

            <!-- Quantitative Risk Score Card -->
            <div id="risk-score-card" style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; display: none;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">Quantitative Risk Assessment</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Technical Risk</div>
                        <div id="tech-risk-score" style="font-size: 1.5rem; font-weight: 600; color: #d4a574;">--</div>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Stakeholder Impact</div>
                        <div id="stakeholder-impact-score" style="font-size: 1.5rem; font-weight: 600; color: #d4a574;">--</div>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Control Effectiveness</div>
                        <div id="control-effectiveness-score" style="font-size: 1.5rem; font-weight: 600; color: #10b981;">--</div>
                    </div>
                </div>
                <div id="residual-risk-display" style="background: white; padding: 1.5rem; border-radius: 8px; text-align: center; border: 2px solid #e5e7eb;">
                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Residual Risk Score</div>
                    <div id="residual-risk-score" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">--</div>
                    <div id="residual-risk-level" style="font-size: 1rem; font-weight: 500; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block;">--</div>
                </div>
                <div id="risk-formula" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 6px; font-size: 0.875rem; color: #6b7280; text-align: center;">
                    <strong>Formula:</strong> Residual Risk = (Technical Risk √ó Stakeholder Impact) √∑ Control Effectiveness
                </div>
            </div>

            <!-- Risk Classifier -->
            <div id="risk-classifier" class="control-gap-register" style="margin-top: 1rem; display: none;">
                <h3>Risk Classification (EU AI Act)</h3>
                <p style="color: #6b7280; margin-bottom: 0.75rem;">
                    Select any high-risk areas your intended AI systems will touch. This triggers stricter readiness thresholds aligned with EU AI Act obligations:
                </p>
                <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="employment"> Employment decisions / HR screening
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="credit_scoring"> Credit scoring / financial services
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="biometric_id"> Biometric identification / sensitive biometrics
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="essential_services"> Access to essential services (health, benefits, utilities)
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="education"> Education / admissions / grading
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #4b5563;">
                        <input type="checkbox" name="risk" value="critical_infrastructure"> Critical infrastructure (energy, transport, water)
                    </label>
                </div>
                <small style="color: #6b7280;">If any are selected, minimum thresholds increase from 40% to 60% for Data Readiness and Risk & Governance.</small>
                <button class="nav-btn btn-next" onclick="recalculateWithRisk()" style="margin-top: 1rem;">Apply Risk Classification</button>
            </div>

            <!-- Export Buttons -->
            <div class="export-buttons">
                <button class="export-btn" onclick="calculateROIFromGaps()" style="background: linear-gradient(135deg, #d4a574 0%, #c19560 100%); color: white; font-weight: 600;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-dollar"/></svg>Calculate Value of Closing Gaps</button>
                <button class="export-btn" onclick="exportUnifiedExcel()" style="background: #10b981; color: white;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-chart"/></svg>Export Excel (Complete Analysis)</button>
                <button class="export-btn" onclick="exportToPowerPoint()" style="background: #ef4444; color: white;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-chart"/></svg>Export PowerPoint (Board Deck)</button>
                <button class="export-btn" onclick="exportToJSON()"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-file"/></svg>Export JSON</button>
                <button class="export-btn" onclick="window.print()"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-printer"/></svg>Export PDF</button>
                <button class="export-btn" onclick="exportControlGaps()"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-list"/></svg>Export Controls (CSV)</button>
                <label class="export-btn">
                    <svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-download"/></svg>Aggregate Results (Multi-Respondent)
                    <input id="agg-input" type="file" accept="application/json" multiple style="display:none;">
                </label>
            </div>

            <!-- Consensus View (Multi-Respondent) -->
            <div id="aggregate-output" class="radar-container" style="display:none;">
                <h3>Consensus View (Multi-Respondent Analysis)</h3>
                <canvas id="radarConsensus"></canvas>
                <p id="consensus-notes" style="color:#6b7280;margin-top:1rem;font-size:0.875rem;"></p>
            </div>

            <!-- Radar Chart -->
            <div class="radar-container">
                <h3>Maturity Radar</h3>
                <canvas id="radarChart"></canvas>
            </div>

            <div class="dimension-scores" id="dimension-scores">
                <!-- Dimension scores will be generated by JavaScript -->
            </div>

            <div class="recommendations">
                <h2>Recommended Next Steps</h2>
                <ul class="recommendation-list" id="recommendations">
                    <!-- Recommendations will be generated by JavaScript -->
                </ul>
            </div>

            <!-- Implementation Roadmap -->
            <div class="roadmap" id="roadmap">
                <!-- Roadmap will be generated by JavaScript -->
            </div>

            <!-- Control Gap Register -->
            <div class="control-gap-register" id="control-gaps">
                <!-- Control gaps will be generated by JavaScript -->
            </div>

            <!-- AI System Card -->
            <div class="system-card" id="system-card">
                <!-- System card will be generated by JavaScript -->
            </div>

            <!-- ISO 42001 Alignment Report -->
            <div class="control-gap-register" id="iso-42001-report" style="display: none;">
                <h3>ISO/IEC 42001:2023 AI Management System Alignment</h3>
                <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
                    Your control gaps mapped to ISO 42001 clauses. This report shows compliance coverage and priority areas for certification readiness.
                </p>
                <div id="iso-alignment-content"></div>
            </div>

            <!-- EU AI Act Compliance Checklist -->
            <div class="control-gap-register" id="eu-ai-act-checklist" style="display: none;">
                <h3>EU AI Act Compliance Checklist</h3>
                <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
                    High-risk AI system requirements mapped to your assessment. Generated based on selected risk areas.
                </p>
                <div id="eu-act-content"></div>
            </div>

            <!-- Executive Readout (Print Only) -->
            <div id="exec-readout" style="display:none;">
                <h2 style="color: #2c3e50; border-bottom: 3px solid #d4a574; padding-bottom: 0.5rem;">AI Readiness Assessment ‚Äî Executive Summary</h2>
                <div style="display: flex; gap: 2rem; margin: 1.5rem 0;">
                    <div><strong>Overall Score:</strong> <span id="exec-overall" style="color: #d4a574; font-size: 1.5rem;"></span></div>
                    <div><strong>Maturity Level:</strong> <span id="exec-maturity" style="color: #d4a574; font-size: 1.5rem;"></span></div>
                </div>
                <div id="exec-gates" style="margin: 1rem 0;"></div>
                <div style="page-break-before: avoid;">
                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">Dimension Scores</h3>
                    <div id="exec-dimensions"></div>
                </div>
                <div style="page-break-before: avoid;">
                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">Top Priority Gaps</h3>
                    <ol id="exec-top-gaps" style="line-height: 1.8;"></ol>
                </div>
                <div style="page-break-before: avoid;">
                    <h3 style="color: #2c3e50; margin-top: 1.5rem;">90-Day Action Plan</h3>
                    <ul id="exec-90" style="line-height: 1.8;"></ul>
                </div>
                <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                    <small style="color: #6b7280;">
                        Assessment aligned with NIST AI RMF, ISO/IEC 42001, ISO/IEC 23894, and EU AI Act.
                        Standards-mapped control gaps available in detailed report.
                    </small>
                </div>
            </div>

            <div class="methodology" style="margin-top: 3rem; padding: 2rem; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #d4a574;">
                <h3 style="margin-bottom: 1rem; color: #2c3e50;">Methodology & Standards Alignment</h3>
                <p style="color: #6b7280; line-height: 1.8; margin-bottom: 1rem;">
                    Your AI Readiness Score is calculated using a <strong>weighted assessment model</strong> that reflects real-world AI implementation priorities and aligns with internationally recognized frameworks:
                </p>
                <ul style="color: #6b7280; line-height: 2; margin-left: 1.5rem;">
                    <li><strong>Data Readiness (40%)</strong> ‚Äì Clean, accessible data is the foundation of any AI initiative</li>
                    <li><strong>Risk & Governance (30%)</strong> ‚Äì Compliance and ethical frameworks gate enterprise AI adoption</li>
                    <li><strong>Technical Capability (10%)</strong> ‚Äì Supporting infrastructure for deployment</li>
                    <li><strong>Business Alignment (10%)</strong> ‚Äì Clear use cases and ROI expectations</li>
                    <li><strong>Organizational Culture (10%)</strong> ‚Äì Team readiness and change management</li>
                </ul>

                <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #2c3e50; font-size: 1rem;">Standards Framework</h4>
                <p style="color: #6b7280; line-height: 1.8; margin-bottom: 0.75rem;">
                    This assessment is mapped to leading AI governance frameworks:
                </p>
                <ul style="color: #6b7280; line-height: 1.8; margin-left: 1.5rem; font-size: 0.9rem;">
                    <li><strong>NIST AI RMF</strong> ‚Äì AI Risk Management Framework organizing controls into Govern, Map, Measure, and Manage functions
                        <a href="https://www.nist.gov/itl/ai-risk-management-framework" target="_blank" style="color: #d4a574;">[Reference]</a></li>
                    <li><strong>ISO/IEC 42001:2023</strong> ‚Äì AI Management Systems (AIMS) requirements
                        <a href="https://www.iso.org/standard/42001" target="_blank" style="color: #d4a574;">[Reference]</a></li>
                    <li><strong>ISO/IEC 23894:2023</strong> ‚Äì AI Risk Management guidance
                        <a href="https://www.iso.org/standard/77304.html" target="_blank" style="color: #d4a574;">[Reference]</a></li>
                    <li><strong>EU AI Act</strong> ‚Äì Risk-based regulatory framework (phased implementation 2024-2027)
                        <a href="https://digital-strategy.ec.europa.eu/en/policies/regulatory-framework-ai" target="_blank" style="color: #d4a574;">[Reference]</a></li>
                </ul>

                <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #2c3e50; font-size: 1rem;">Gating Logic & Risk Classification</h4>
                <p style="color: #6b7280; line-height: 1.8; margin-bottom: 0.75rem; font-size: 0.9rem;">
                    Organizations must achieve minimum thresholds in critical dimensions (Data Readiness ‚â•40%, Risk & Governance ‚â•40%) to progress beyond "Exploring" maturity.
                    High-risk use cases (employment decisions, credit scoring, critical infrastructure) trigger elevated minimum requirements aligned with EU AI Act obligations (Data Readiness & Risk/Governance ‚â•60%).
                </p>

                <p style="color: #6b7280; line-height: 1.8; margin-top: 1.5rem; font-size: 0.9rem;">
                    <em>Note: This is a directional assessment based on 10 questions. For a comprehensive audit, consider a full readiness review with detailed stakeholder interviews, technical evaluation, and evidence-based control verification.</em>
                </p>
                <p style="color: #059669; line-height: 1.6; margin-top: 1.5rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem;">
                    üîí <strong>Privacy:</strong> All calculations run in your browser. We don't store or transmit your responses, and restarting clears any locally saved answers.
                </p>
            </div>

            <button class="restart-btn" onclick="restartAssessment()">Take Assessment Again</button>
        </div>
    </div>

    <script>
        const questions = [
            {
                id: 1,
                category: "Data Readiness",
                text: "How would you describe your organization's data infrastructure?",
                meta: { nist: "Map", iso_42001: "7.4", iso_23894: "6.2", eu_ai_act: "Data Governance", control_id: "DS-1" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our current data infrastructure state", isUnsure: true },
                    { value: 1, label: "Ad-hoc", description: "Data is scattered across spreadsheets and individual systems" },
                    { value: 2, label: "Basic", description: "Some centralized databases but limited integration" },
                    { value: 3, label: "Structured", description: "Well-organized data warehouse with regular ETL processes" },
                    { value: 4, label: "Advanced", description: "Real-time data pipeline with quality monitoring and governance" }
                ]
            },
            {
                id: 2,
                category: "Data Readiness",
                text: "When your team needs to answer a novel, critical business question, how quickly can they access and integrate the required data?",
                meta: { nist: "Map", iso_42001: "7.4", iso_23894: "6.2.2", eu_ai_act: "Data Quality", control_id: "DS-2" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our data access capabilities", isUnsure: true },
                    { value: 1, label: "Weeks or months", description: "Requires significant manual intervention and data engineering" },
                    { value: 2, label: "Days", description: "Data is available but requires considerable cleaning and preparation" },
                    { value: 3, label: "Hours", description: "Data is largely accessible via self-service tools with some minor prep" },
                    { value: 4, label: "Minutes/On-demand", description: "Data is consistently clean, cataloged, and available via automated pipelines" }
                ]
            },
            {
                id: 3,
                category: "Technical Capability",
                text: "What is your team's current AI/ML expertise level?",
                meta: { nist: "Govern", iso_42001: "7.2", iso_23894: "5.3", eu_ai_act: "Competency", control_id: "TC-1" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our team's AI/ML capabilities", isUnsure: true },
                    { value: 1, label: "Minimal", description: "No dedicated AI expertise, would need external help" },
                    { value: 2, label: "Basic", description: "Some employees with basic ML knowledge or interest" },
                    { value: 3, label: "Intermediate", description: "Small team with practical ML experience" },
                    { value: 4, label: "Advanced", description: "Established data science team with production ML experience" }
                ]
            },
            {
                id: 4,
                category: "Technical Capability",
                text: "How quickly can your organization scale resources to train a new, complex AI model or handle a 10x surge in usage?",
                meta: { nist: "Manage", iso_42001: "8.3", iso_23894: "6.4", eu_ai_act: "Technical Infrastructure", control_id: "TC-2" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our infrastructure scaling capabilities", isUnsure: true },
                    { value: 1, label: "We can't", description: "Infrastructure is fixed and on-premise" },
                    { value: 2, label: "Weeks", description: "Requires major procurement and configuration effort" },
                    { value: 3, label: "Days", description: "Can provision through cloud provider with some setup" },
                    { value: 4, label: "Automated/On-demand", description: "Resources scale automatically without manual intervention" }
                ]
            },
            {
                id: 5,
                category: "Business Alignment",
                text: "How well-defined are your AI use cases and business objectives?",
                meta: { nist: "Govern", iso_42001: "5.1, 6.1", iso_23894: "5.1", eu_ai_act: "Purpose Definition", control_id: "BA-1" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our AI use case planning status", isUnsure: true },
                    { value: 1, label: "Exploratory", description: "General interest but no specific use cases identified" },
                    { value: 2, label: "Emerging", description: "Some ideas but lacking clear business case or metrics" },
                    { value: 3, label: "Defined", description: "Clear use cases with estimated ROI and success metrics" },
                    { value: 4, label: "Strategic", description: "AI roadmap integrated with business strategy and KPIs" }
                ],
                riskIndicator: true // Helps identify high-risk use cases
            },
            {
                id: 6,
                category: "Business Alignment",
                text: "What's your leadership's stance on AI adoption?",
                meta: { nist: "Govern", iso_42001: "5.2", iso_23894: "5.1", eu_ai_act: "Leadership & Accountability", control_id: "BA-2" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of leadership's AI position", isUnsure: true },
                    { value: 1, label: "Skeptical", description: "Leadership is cautious or unconvinced about AI value" },
                    { value: 2, label: "Curious", description: "Open to exploring but needs more education" },
                    { value: 3, label: "Supportive", description: "Active support with allocated budget for pilots" },
                    { value: 4, label: "Champion", description: "Leadership driving AI transformation with full commitment" }
                ]
            },
            {
                id: 7,
                category: "Organizational Culture",
                text: "How does your organization typically approach new technology adoption?",
                meta: { nist: "Govern", iso_42001: "7.3", iso_23894: "5.3", eu_ai_act: "Change Management", control_id: "OC-1" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our technology adoption patterns", isUnsure: true },
                    { value: 1, label: "Conservative", description: "Wait for proven solutions, avoid early adoption" },
                    { value: 2, label: "Cautious", description: "Adopt after thorough vetting and peer validation" },
                    { value: 3, label: "Progressive", description: "Willing to pilot new technologies with proper planning" },
                    { value: 4, label: "Innovative", description: "Culture of experimentation and continuous learning" }
                ]
            },
            {
                id: 8,
                category: "Organizational Culture",
                text: "How prepared is your workforce for AI-driven changes?",
                meta: { nist: "Govern", iso_42001: "7.2", iso_23894: "5.3", eu_ai_act: "Human Oversight", control_id: "OC-2" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of workforce AI readiness", isUnsure: true },
                    { value: 1, label: "Resistant", description: "Significant concerns about job displacement" },
                    { value: 2, label: "Uncertain", description: "Mixed feelings, need more communication and training" },
                    { value: 3, label: "Open", description: "Generally positive with some reskilling initiatives" },
                    { value: 4, label: "Eager", description: "Excited about AI augmentation with active upskilling" }
                ]
            },
            {
                id: 9,
                category: "Risk & Governance",
                text: "What's your approach to AI ethics and governance?",
                meta: { nist: "Govern", iso_42001: "6.2, 8.1", iso_23894: "7.3", eu_ai_act: "Risk Management System", control_id: "GOV-1" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our AI ethics approach", isUnsure: true },
                    { value: 1, label: "Undefined", description: "Haven't considered AI-specific risks or ethics" },
                    { value: 2, label: "Aware", description: "Recognize the importance but no formal framework" },
                    { value: 3, label: "Developing", description: "Working on guidelines and responsible AI practices" },
                    { value: 4, label: "Established", description: "Clear AI governance framework with ethics committee" }
                ]
            },
            {
                id: 10,
                category: "Risk & Governance",
                text: "How do you handle data privacy and security for AI systems?",
                meta: { nist: "Manage", iso_42001: "8.2", iso_23894: "7.1", eu_ai_act: "Logging & Monitoring", control_id: "GOV-2" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our AI security practices", isUnsure: true },
                    { value: 1, label: "Basic", description: "Standard IT security with no AI-specific measures" },
                    { value: 2, label: "Compliant", description: "Meet regulatory requirements but minimal beyond" },
                    { value: 3, label: "Proactive", description: "Strong data governance with privacy-by-design approach" },
                    { value: 4, label: "Advanced", description: "Comprehensive framework including model security and auditing" }
                ]
            },
            {
                id: 11,
                category: "Technical Capability",
                text: "What is your organization's strategy for acquiring and developing AI talent?",
                meta: { nist: "Govern", iso_42001: "7.2", iso_23894: "5.3", eu_ai_act: "Competency Development", control_id: "TC-3" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our AI talent strategy", isUnsure: true },
                    { value: 1, label: "Ad-hoc", description: "We hire when a specific need becomes critical" },
                    { value: 2, label: "Reactive", description: "We have a budget for external hires but no internal development plan" },
                    { value: 3, label: "Proactive", description: "We have an active internal upskilling program and dedicated recruiting pipeline" },
                    { value: 4, label: "Strategic", description: "We have a comprehensive talent strategy including university partnerships, retention programs, and defined career paths for AI roles" }
                ]
            },
            {
                id: 12,
                category: "Business Alignment",
                text: "How are insights from AI models integrated into day-to-day business operations?",
                meta: { nist: "Manage", iso_42001: "8.3", iso_23894: "6.5", eu_ai_act: "Human Oversight", control_id: "BA-3" },
                options: [
                    { value: 0, label: "I don't know", description: "Unsure of our AI integration approach", isUnsure: true },
                    { value: 1, label: "Manually", description: "Analysts create reports/dashboards which are reviewed periodically" },
                    { value: 2, label: "Alert-driven", description: "Models generate alerts that require manual review and action" },
                    { value: 3, label: "Integrated", description: "Model outputs directly trigger tasks or recommendations within core systems (e.g., CRM, ERP)" },
                    { value: 4, label: "Autonomous", description: "Models autonomously execute operational decisions within pre-defined guardrails" }
                ]
            }
        ];

        let currentQuestion = 0;
        let answers = {};
        let questionElements = [];
        let radarChartInstance = null;
        let consensusChartInstance = null;

        // Initialize Supabase
        const SUPABASE_URL = 'https://hzverggjspltpopivtgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dmVyZ2dqc3BsdHBvcGl2dGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzUxMDQsImV4cCI6MjA3NTI1MTEwNH0.n8S0BHP33VAP8KMEkHIBHcDdTapBOfnqwB8D1qf9pv4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Track session and participant IDs
        let sessionId = null;
        let participantId = null;
        let organizationId = null;

        // Evidence library for control gaps
        const EVIDENCE_LIBRARY = {
            "DS-1": ["Current-state data architecture diagram", "System/data inventory (owner, steward)", "ETL/ELT runbooks"],
            "DS-2": ["Data quality KPIs (completeness, accuracy)", "Data catalog screenshots", "Data lineage for pilot datasets"],
            "GOV-1": ["AI policy & risk taxonomy", "RAI committee charter & minutes", "Risk register entries for AI use cases"],
            "GOV-2": ["Model logging policy", "Security threat model for AI systems", "Incident response playbook for models"],
            "TC-1": ["Team skill matrix & role descriptions", "Training curriculum & completion records"],
            "TC-2": ["MLOps pipeline docs", "GPU/compute quotas & access controls"],
            "TC-3": ["AI talent acquisition plan", "Career progression framework for AI roles", "University/bootcamp partnership agreements"],
            "BA-1": ["Use-case briefs with ROI hypothesis", "Value tracking plan & KPIs"],
            "BA-2": ["Executive sponsorship memo", "Budget approval / OKR alignment"],
            "BA-3": ["AI integration architecture diagrams", "Workflow automation documentation", "Model deployment SOPs"],
            "OC-1": ["Change management plan", "Comms calendar & FAQs"],
            "OC-2": ["Upskilling plan", "Human-in-the-loop SOPs"]
        };

        // ============================================================================
        // INTEGRATED CONFIGURATION: Industry Presets for Assessment + ROI Integration
        // ============================================================================
        const INTEGRATED_CONFIG = {
            'financial-services': {
                label: 'Financial Services',

                // Assessment configuration
                assessment: {
                    weights: {
                        'Data Readiness': 0.35,
                        'Technical Capability': 0.15,
                        'Business Alignment': 0.10,
                        'Organizational Culture': 0.05,
                        'Risk & Governance': 0.35
                    },
                    riskDefaults: ['credit_scoring', 'employment'],
                    minFloor: 60, // High-risk threshold for this industry
                    regulatoryNote: 'Additional compliance: Basel III, SR 11-7, DORA, GDPR',
                    benchmarks: { p25: 45, p50: 58, p75: 73, p90: 84 }
                },

                // ROI assumptions (for integration)
                roi: {
                    avgSalary: 120000,
                    platformCost: 500000,
                    annualComplianceCost: 200000,
                    implementationMonths: 9,
                    modelValidationCost: 150000,
                    riskMultiplier: 1.3 // Higher risk = longer timelines
                },

                // Gap-to-cost mapping (control gaps add penalties to ROI)
                gapImpact: {
                    'DS-1': { cost: 75000, months: 2, description: 'Data architecture gaps increase migration complexity' },
                    'DS-2': { cost: 50000, months: 1, description: 'Data quality issues require extensive remediation' },
                    'GOV-1': { cost: 200000, months: 3, description: 'Missing governance framework triggers regulatory scrutiny' },
                    'GOV-2': { cost: 150000, months: 2, description: 'Security gaps require extensive model hardening' },
                    'TC-1': { cost: 100000, months: 2, description: 'Skill gaps require external expertise/training' },
                    'TC-2': { cost: 120000, months: 2, description: 'Infrastructure gaps delay deployment readiness' },
                    'TC-3': { cost: 80000, months: 2, description: 'Talent acquisition gaps extend time to competency' },
                    'BA-1': { cost: 40000, months: 1, description: 'Unclear business case slows stakeholder buy-in' },
                    'BA-2': { cost: 60000, months: 1, description: 'Weak sponsorship causes priority conflicts' },
                    'BA-3': { cost: 50000, months: 1, description: 'Poor integration limits AI value realization' },
                    'OC-1': { cost: 30000, months: 1, description: 'Change resistance requires additional comms/training' },
                    'OC-2': { cost: 45000, months: 1, description: 'Upskilling gaps delay user adoption' }
                }
            },

            'healthcare': {
                label: 'Healthcare & Life Sciences',

                assessment: {
                    weights: {
                        'Data Readiness': 0.30,
                        'Technical Capability': 0.15,
                        'Business Alignment': 0.15,
                        'Organizational Culture': 0.10,
                        'Risk & Governance': 0.30
                    },
                    riskDefaults: ['medical_diagnosis', 'patient_safety'],
                    minFloor: 65, // Stricter due to patient safety
                    regulatoryNote: 'Additional compliance: HIPAA, FDA 21 CFR Part 11, EU MDR',
                    benchmarks: { p25: 42, p50: 55, p75: 70, p90: 82 }
                },

                roi: {
                    avgSalary: 95000,
                    platformCost: 400000,
                    annualComplianceCost: 250000, // Higher due to healthcare regs
                    implementationMonths: 12,
                    modelValidationCost: 200000, // FDA/clinical validation
                    riskMultiplier: 1.5 // Patient safety = highest caution
                },

                gapImpact: {
                    'DS-1': { cost: 65000, months: 2, description: 'EHR/FHIR integration complexity' },
                    'DS-2': { cost: 80000, months: 2, description: 'Clinical data quality critical for patient safety' },
                    'GOV-1': { cost: 250000, months: 4, description: 'HIPAA/ethics frameworks non-negotiable' },
                    'GOV-2': { cost: 180000, months: 3, description: 'PHI security breaches carry severe penalties' },
                    'TC-1': { cost: 120000, months: 3, description: 'Clinical AI requires specialized expertise' },
                    'TC-2': { cost: 100000, months: 2, description: 'HIPAA-compliant infrastructure required' },
                    'TC-3': { cost: 95000, months: 3, description: 'Clinical AI talent scarce, requires specialized recruiting' },
                    'BA-1': { cost: 50000, months: 2, description: 'Clinical workflow alignment critical' },
                    'BA-2': { cost: 70000, months: 2, description: 'Physician buy-in essential for adoption' },
                    'BA-3': { cost: 65000, months: 2, description: 'EHR/clinical workflow integration essential for adoption' },
                    'OC-1': { cost: 45000, months: 2, description: 'Clinician change resistance high' },
                    'OC-2': { cost: 60000, months: 2, description: 'Clinical training & certification required' }
                }
            },

            'public-sector': {
                label: 'Public Sector & Government',

                assessment: {
                    weights: {
                        'Data Readiness': 0.25,
                        'Technical Capability': 0.15,
                        'Business Alignment': 0.15,
                        'Organizational Culture': 0.15,
                        'Risk & Governance': 0.30
                    },
                    riskDefaults: ['law_enforcement', 'public_services'],
                    minFloor: 60,
                    regulatoryNote: 'Additional compliance: NIST 800-53, FedRAMP, EU AI Act (public use)',
                    benchmarks: { p25: 38, p50: 50, p75: 65, p90: 78 }
                },

                roi: {
                    avgSalary: 85000,
                    platformCost: 350000,
                    annualComplianceCost: 180000,
                    implementationMonths: 14, // Procurement cycles are longer
                    modelValidationCost: 120000,
                    riskMultiplier: 1.4 // Public accountability
                },

                gapImpact: {
                    'DS-1': { cost: 55000, months: 3, description: 'Legacy system modernization challenges' },
                    'DS-2': { cost: 45000, months: 2, description: 'Data siloes across agencies' },
                    'GOV-1': { cost: 180000, months: 4, description: 'Transparency & accountability mandates' },
                    'GOV-2': { cost: 140000, months: 3, description: 'FedRAMP/NIST security requirements' },
                    'TC-1': { cost: 90000, months: 3, description: 'Limited in-house AI expertise' },
                    'TC-2': { cost: 85000, months: 3, description: 'Modernization budget constraints' },
                    'TC-3': { cost: 70000, months: 4, description: 'Public sector talent recruitment limitations (salary, clearance)' },
                    'BA-1': { cost: 60000, months: 2, description: 'Multi-stakeholder alignment complexity' },
                    'BA-2': { cost: 80000, months: 3, description: 'Political/budget cycle dependencies' },
                    'BA-3': { cost: 55000, months: 3, description: 'Legacy process integration extends deployment timelines' },
                    'OC-1': { cost: 50000, months: 2, description: 'Bureaucratic change resistance' },
                    'OC-2': { cost: 55000, months: 2, description: 'Workforce age/digital divide' }
                }
            },

            'retail': {
                label: 'Retail & E-Commerce',

                assessment: {
                    weights: {
                        'Data Readiness': 0.35,
                        'Technical Capability': 0.20,
                        'Business Alignment': 0.20,
                        'Organizational Culture': 0.10,
                        'Risk & Governance': 0.15
                    },
                    riskDefaults: [],
                    minFloor: 40, // Lower regulatory burden
                    regulatoryNote: 'Additional compliance: GDPR (EU customers), CCPA, PCI-DSS',
                    benchmarks: { p25: 48, p50: 62, p75: 76, p90: 88 }
                },

                roi: {
                    avgSalary: 75000,
                    platformCost: 275000,
                    annualComplianceCost: 80000,
                    implementationMonths: 6,
                    modelValidationCost: 60000,
                    riskMultiplier: 1.1 // Fast-paced, lower regulatory risk
                },

                gapImpact: {
                    'DS-1': { cost: 45000, months: 1, description: 'E-commerce data integration gaps' },
                    'DS-2': { cost: 40000, months: 1, description: 'Customer data quality for personalization' },
                    'GOV-1': { cost: 80000, months: 2, description: 'Privacy controls for customer data' },
                    'GOV-2': { cost: 70000, months: 1, description: 'API security for customer-facing AI' },
                    'TC-1': { cost: 65000, months: 2, description: 'ML engineering for recommendations' },
                    'TC-2': { cost: 80000, months: 1, description: 'Cloud infrastructure for scale' },
                    'TC-3': { cost: 55000, months: 1, description: 'Competitive talent market, rapid hiring needs' },
                    'BA-1': { cost: 35000, months: 1, description: 'ROI tracking for AI initiatives' },
                    'BA-2': { cost: 45000, months: 1, description: 'Executive buy-in for innovation' },
                    'BA-3': { cost: 40000, months: 1, description: 'Real-time integration to ecommerce/POS systems critical' },
                    'OC-1': { cost: 25000, months: 1, description: 'Fast-paced culture aids adoption' },
                    'OC-2': { cost: 30000, months: 1, description: 'Customer-facing teams training' }
                }
            },

            'manufacturing': {
                label: 'Manufacturing & Industrial',

                assessment: {
                    weights: {
                        'Data Readiness': 0.30,
                        'Technical Capability': 0.25,
                        'Business Alignment': 0.15,
                        'Organizational Culture': 0.10,
                        'Risk & Governance': 0.20
                    },
                    riskDefaults: ['critical_infrastructure'],
                    minFloor: 50,
                    regulatoryNote: 'Additional compliance: ISO 9001, IEC 62443, OSHA safety standards',
                    benchmarks: { p25: 40, p50: 54, p75: 68, p90: 80 }
                },

                roi: {
                    avgSalary: 90000,
                    platformCost: 450000,
                    annualComplianceCost: 120000,
                    implementationMonths: 10,
                    modelValidationCost: 100000,
                    riskMultiplier: 1.2 // Safety-critical systems
                },

                gapImpact: {
                    'DS-1': { cost: 70000, months: 2, description: 'IoT/OT data integration challenges' },
                    'DS-2': { cost: 60000, months: 2, description: 'Sensor data quality for predictive maintenance' },
                    'GOV-1': { cost: 150000, months: 3, description: 'Safety governance for autonomous systems' },
                    'GOV-2': { cost: 130000, months: 2, description: 'OT/IT security convergence' },
                    'TC-1': { cost: 110000, months: 2, description: 'Industrial AI/robotics expertise' },
                    'TC-2': { cost: 140000, months: 2, description: 'Edge computing infrastructure' },
                    'TC-3': { cost: 85000, months: 2, description: 'Industrial AI talent scarce, requires domain + tech skills' },
                    'BA-1': { cost: 50000, months: 1, description: 'Production efficiency ROI alignment' },
                    'BA-2': { cost: 65000, months: 2, description: 'Operations leadership buy-in' },
                    'BA-3': { cost: 60000, months: 2, description: 'MES/SCADA integration critical for operational value' },
                    'OC-1': { cost: 40000, months: 2, description: 'Shop floor culture change management' },
                    'OC-2': { cost: 55000, months: 2, description: 'Operator training on AI systems' }
                }
            },

            'generic': {
                label: 'General / Other Industry',

                assessment: {
                    weights: {
                        'Data Readiness': 0.40,
                        'Technical Capability': 0.10,
                        'Business Alignment': 0.10,
                        'Organizational Culture': 0.10,
                        'Risk & Governance': 0.30
                    },
                    riskDefaults: [],
                    minFloor: 40,
                    regulatoryNote: 'Baseline compliance: GDPR (if EU), local data protection laws',
                    benchmarks: { p25: 43, p50: 57, p75: 71, p90: 83 }
                },

                roi: {
                    avgSalary: 95000,
                    platformCost: 400000,
                    annualComplianceCost: 150000,
                    implementationMonths: 8,
                    modelValidationCost: 100000,
                    riskMultiplier: 1.2
                },

                gapImpact: {
                    'DS-1': { cost: 60000, months: 2, description: 'Data infrastructure gaps' },
                    'DS-2': { cost: 50000, months: 1, description: 'Data quality remediation' },
                    'GOV-1': { cost: 150000, months: 3, description: 'Governance framework development' },
                    'GOV-2': { cost: 120000, months: 2, description: 'Security controls implementation' },
                    'TC-1': { cost: 90000, months: 2, description: 'AI expertise acquisition' },
                    'TC-2': { cost: 100000, months: 2, description: 'Infrastructure modernization' },
                    'TC-3': { cost: 75000, months: 2, description: 'Talent strategy and pipeline development' },
                    'BA-1': { cost: 45000, months: 1, description: 'Business case development' },
                    'BA-2': { cost: 55000, months: 1, description: 'Executive alignment' },
                    'BA-3': { cost: 50000, months: 1, description: 'AI integration into business workflows' },
                    'OC-1': { cost: 35000, months: 1, description: 'Change management program' },
                    'OC-2': { cost: 40000, months: 1, description: 'Skills development' }
                }
            }
        };

        // Current selected industry (default to generic)
        let currentIndustry = 'generic';

        // DRY scoring function (now uses configurable weights)
        function computeScores(answersObj) {
            const dims = {
                "Data Readiness": [],
                "Technical Capability": [],
                "Business Alignment": [],
                "Organizational Culture": [],
                "Risk & Governance": []
            };

            questions.forEach((q, i) => {
                if (answersObj[i] !== undefined) {
                    // Treat "I don't know" (value=0) as highest risk (value=1)
                    const answerValue = answersObj[i] === 0 ? 1 : answersObj[i];
                    dims[q.category].push(answerValue);
                }
            });

            const dimScores = {};
            for (const [k, v] of Object.entries(dims)) {
                if (v.length > 0) {
                    dimScores[k] = (v.reduce((a, b) => a + b, 0) / v.length) / 4 * 100;
                }
            }

            // Use industry-specific weights (or generic if no industry selected)
            const weights = INTEGRATED_CONFIG[currentIndustry]?.assessment.weights || {
                'Data Readiness': 0.4,
                'Technical Capability': 0.1,
                'Business Alignment': 0.1,
                'Organizational Culture': 0.1,
                'Risk & Governance': 0.3
            };

            let ws = 0, sum = 0;
            for (const [k, s] of Object.entries(dimScores)) {
                sum += (weights[k] || 0) * s;
                ws += (weights[k] || 0);
            }

            const overall = Math.round(sum / (ws || 1));
            return { dimScores, overall, weights };
        }

        // Calculate Quantitative Risk Score (EY-style: Technical √ó Impact / Controls)
        function calculateQuantitativeRisk(dimensionScores, highRiskSelected) {
            // Technical Risk: Based on technical capability (lower capability = higher risk)
            const technicalCapability = dimensionScores['Technical Capability'] || 50;
            const technicalRisk = 100 - technicalCapability;

            // Stakeholder Impact: Based on high-risk areas + business alignment
            const businessAlignment = dimensionScores['Business Alignment'] || 50;
            let stakeholderImpact = highRiskSelected ? 70 : 30; // Base impact

            // Adjust based on business alignment (higher alignment = more stakeholders affected)
            stakeholderImpact += (businessAlignment - 50) * 0.4; // ¬±20 points max adjustment
            stakeholderImpact = Math.max(0, Math.min(100, stakeholderImpact)); // Clamp to 0-100

            // Control Effectiveness: Based on governance score (can't be 0 to avoid division by zero)
            const governance = dimensionScores['Risk & Governance'] || 1;
            const controlEffectiveness = Math.max(governance, 1);

            // Residual Risk = (Technical √ó Impact) / Controls, normalized to 0-100
            // We scale the result to fit 0-100 range
            const residualRisk = ((technicalRisk * stakeholderImpact) / controlEffectiveness);

            // Determine risk level
            let riskLevel, riskColor, riskBgColor;
            if (residualRisk < 25) {
                riskLevel = 'Low Risk';
                riskColor = '#10b981';
                riskBgColor = '#d1fae5';
            } else if (residualRisk < 50) {
                riskLevel = 'Medium Risk';
                riskColor = '#f59e0b';
                riskBgColor = '#fef3c7';
            } else if (residualRisk < 75) {
                riskLevel = 'High Risk';
                riskColor = '#ef4444';
                riskBgColor = '#fee2e2';
            } else {
                riskLevel = 'Critical Risk';
                riskColor = '#dc2626';
                riskBgColor = '#fecaca';
            }

            return {
                technicalRisk: Math.round(technicalRisk),
                stakeholderImpact: Math.round(stakeholderImpact),
                controlEffectiveness: Math.round(controlEffectiveness),
                residualRisk: Math.round(residualRisk),
                riskLevel,
                riskColor,
                riskBgColor
            };
        }

        // Display quantitative risk scores
        function displayQuantitativeRisk(riskData) {
            document.getElementById('risk-score-card').style.display = 'block';
            document.getElementById('tech-risk-score').textContent = riskData.technicalRisk;
            document.getElementById('stakeholder-impact-score').textContent = riskData.stakeholderImpact;
            document.getElementById('control-effectiveness-score').textContent = riskData.controlEffectiveness + '%';
            document.getElementById('residual-risk-score').textContent = riskData.residualRisk;
            document.getElementById('residual-risk-score').style.color = riskData.riskColor;

            const riskLevelEl = document.getElementById('residual-risk-level');
            riskLevelEl.textContent = riskData.riskLevel;
            riskLevelEl.style.backgroundColor = riskData.riskBgColor;
            riskLevelEl.style.color = riskData.riskColor;
        }

        // Calculate and display benchmark comparison
        function displayBenchmark(score) {
            const benchmarks = INTEGRATED_CONFIG[currentIndustry]?.assessment.benchmarks;
            if (!benchmarks) return;

            const { p25, p50, p75, p90 } = benchmarks;

            // Calculate approximate percentile
            let percentile;
            if (score < p25) {
                percentile = Math.round((score / p25) * 25);
            } else if (score < p50) {
                percentile = 25 + Math.round(((score - p25) / (p50 - p25)) * 25);
            } else if (score < p75) {
                percentile = 50 + Math.round(((score - p50) / (p75 - p50)) * 25);
            } else if (score < p90) {
                percentile = 75 + Math.round(((score - p75) / (p90 - p75)) * 15);
            } else {
                percentile = 90 + Math.round(((score - p90) / (100 - p90)) * 10);
            }

            // Update UI
            document.getElementById('benchmark-indicator').style.display = 'block';
            document.getElementById('percentile-badge').textContent = `${percentile}th Percentile`;

            // Description based on performance
            let description;
            if (percentile >= 75) {
                description = `Your score of ${score}% places you in the top quartile for ${INTEGRATED_CONFIG[currentIndustry].label}. You're outperforming 3 out of 4 peer organizations.`;
            } else if (percentile >= 50) {
                description = `Your score of ${score}% is above the median for ${INTEGRATED_CONFIG[currentIndustry].label}. You're ahead of more than half of peer organizations.`;
            } else if (percentile >= 25) {
                description = `Your score of ${score}% places you in the second quartile for ${INTEGRATED_CONFIG[currentIndustry].label}. There's room to improve toward the median (${p50}%).`;
            } else {
                description = `Your score of ${score}% is below the first quartile for ${INTEGRATED_CONFIG[currentIndustry].label}. Significant opportunity to advance toward peer benchmarks.`;
            }

            document.getElementById('benchmark-description').textContent = description;

            // Position user marker on the scale
            const markerPosition = Math.max(0, Math.min(100, score));
            document.getElementById('user-marker').style.left = `${markerPosition}%`;

            // Update percentile labels
            document.getElementById('p25-label').textContent = `p25: ${p25}`;
            document.getElementById('p50-label').textContent = `p50: ${p50}`;
            document.getElementById('p75-label').textContent = `p75: ${p75}`;
        }

        // Check if high-risk use cases are selected
        function isHighRiskSelected() {
            const checks = Array.from(document.querySelectorAll('#risk-classifier input[name="risk"]:checked'));
            return checks.length > 0;
        }

        // Recalculate with risk classification
        function recalculateWithRisk() {
            // Get selected risk areas
            const selectedRisks = Array.from(document.querySelectorAll('#risk-classifier input[name="risk"]:checked'))
                .map(cb => cb.value);

            // Show feedback based on selection
            const button = event.target;
            const originalText = button.innerHTML;
            const originalBg = button.style.background;

            if (selectedRisks.length > 0) {
                button.innerHTML = '<svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-check"/></svg>High-Risk Classification Applied';
                button.style.background = '#10b981';

                // Show alert about impact
                const alertDiv = document.createElement('div');
                alertDiv.id = 'risk-alert';
                alertDiv.style.cssText = 'background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin: 1rem 0; border-radius: 4px;';
                alertDiv.innerHTML = `
                    <strong style="color: #f59e0b;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-alert"/></svg>High-Risk Mode Activated</strong><br>
                    <small style="color: #92400e;">Minimum threshold increased to 60% for Data Readiness and Risk & Governance dimensions.</small>
                `;

                const riskSection = document.getElementById('risk-classifier');
                const existingAlert = document.getElementById('risk-alert');
                if (existingAlert) existingAlert.remove();
                riskSection.appendChild(alertDiv);
            } else {
                button.innerHTML = '<svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-check"/></svg>Standard Classification Applied';
                button.style.background = '#6b7280';

                // Remove any existing alerts
                const existingAlert = document.getElementById('risk-alert');
                if (existingAlert) existingAlert.remove();
            }

            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = originalBg;
            }, 2000);

            // Recalculate results
            showResults();
        }

        // Apply industry preset configuration
        function applyIndustryPreset(industry) {
            currentIndustry = industry;
            const config = INTEGRATED_CONFIG[industry];

            if (!config) return;

            // Update UI to show industry-specific information
            const weights = config.assessment.weights;
            const topDimensions = Object.entries(weights)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 2)
                .map(([dim, weight]) => `${dim} (${(weight * 100).toFixed(0)}%)`)
                .join(', ');

            document.getElementById('industry-weights').textContent = `Emphasis on ${topDimensions}`;
            document.getElementById('industry-regs').textContent = config.assessment.regulatoryNote;

            // Pre-select risk defaults for this industry
            const riskCheckboxes = document.querySelectorAll('#risk-classifier input[name="risk"]');
            riskCheckboxes.forEach(checkbox => {
                checkbox.checked = config.assessment.riskDefaults.includes(checkbox.value);
            });

            // Save industry selection to localStorage
            localStorage.setItem('selectedIndustry', industry);

            // Recalculate if user has already started answering
            if (Object.keys(answers).length > 0) {
                const resultsVisible = document.getElementById('results').classList.contains('active');
                if (resultsVisible) {
                    showResults(); // Recalculate with new industry weights
                }
            }
        }

        // Initialize assessment session in Supabase
        async function initializeSession() {
            // Check if we already have a session in this browser session
            const existingSessionId = sessionStorage.getItem('assessment_session_id');
            const existingParticipantId = sessionStorage.getItem('assessment_participant_id');

            if (existingSessionId && existingParticipantId) {
                sessionId = existingSessionId;
                participantId = existingParticipantId;
                console.log('Resuming existing session:', sessionId);
                return;
            }

            try {
                // Create organization (anonymous for now)
                const { data: org, error: orgError } = await supabase
                    .from('organizations')
                    .insert({ name: 'Anonymous Organization' })
                    .select()
                    .single();

                if (orgError) throw orgError;
                organizationId = org.id;

                // Create assessment session
                const { data: session, error: sessionError } = await supabase
                    .from('assessment_sessions')
                    .insert({
                        organization_id: organizationId,
                        type: 'individual',
                        status: 'in_progress',
                        title: 'AI Readiness Assessment',
                        is_premium: false
                    })
                    .select()
                    .single();

                if (sessionError) throw sessionError;
                sessionId = session.id;

                // Create participant record
                const { data: participant, error: participantError } = await supabase
                    .from('participants')
                    .insert({
                        session_id: sessionId,
                        started_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (participantError) throw participantError;
                participantId = participant.id;

                // Save to sessionStorage
                sessionStorage.setItem('assessment_session_id', sessionId);
                sessionStorage.setItem('assessment_participant_id', participantId);

                console.log('Created new session:', sessionId);
            } catch (error) {
                console.error('Error initializing session:', error);
                // Fall back to localStorage mode if Supabase fails
                alert('Unable to save your progress online. Your answers will be saved locally.');
            }
        }

        // Save progress to Supabase
        async function saveProgress() {
            // Also save to localStorage as backup
            localStorage.setItem('ai_assessment_answers', JSON.stringify(answers));

            if (!participantId) {
                // Initialize session on first answer
                await initializeSession();
            }

            if (!participantId) {
                console.warn('No participant ID, skipping Supabase save');
                return;
            }

            try {
                // Save all current answers to Supabase
                const responseRecords = Object.entries(answers).map(([questionIndex, value]) => {
                    const question = questions[parseInt(questionIndex)];
                    return {
                        participant_id: participantId,
                        question_key: `individual_q${questionIndex}`,
                        dimension: question.category,
                        response_value: value.toString()
                    };
                });

                // Delete existing responses for this participant first
                await supabase
                    .from('assessment_responses')
                    .delete()
                    .eq('participant_id', participantId);

                // Insert new responses
                const { error } = await supabase
                    .from('assessment_responses')
                    .insert(responseRecords);

                if (error) throw error;
                console.log('Saved', responseRecords.length, 'responses to Supabase');
            } catch (error) {
                console.error('Error saving to Supabase:', error);
            }
        }

        function loadProgress() {
            try {
                // Load from localStorage as fallback
                const saved = localStorage.getItem('ai_assessment_answers');
                if (saved) {
                    answers = JSON.parse(saved);
                }
            } catch {
                answers = {};
            }

            // Load saved industry selection
            const savedIndustry = localStorage.getItem('selectedIndustry');
            if (savedIndustry && INTEGRATED_CONFIG[savedIndustry]) {
                document.getElementById('industry-selector').value = savedIndustry;
                applyIndustryPreset(savedIndustry);
            }
        }

        // Enhance accessibility
        function enhanceAccessibility() {
            document.querySelectorAll('.options-grid').forEach(grid => {
                grid.setAttribute('role', 'radiogroup');
                const opts = Array.from(grid.querySelectorAll('.option'));
                opts.forEach((opt, idx) => {
                    opt.setAttribute('role', 'radio');
                    opt.setAttribute('tabindex', idx === 0 ? '0' : '-1');
                    opt.setAttribute('aria-checked', 'false');
                    opt.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                            (opts[idx + 1] || opts[0]).focus();
                        }
                        if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                            (opts[idx - 1] || opts[opts.length - 1]).focus();
                        }
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            opt.click();
                        }
                    });
                });
            });
        }

        function initAssessment() {
            // Create question containers
            const questionsContainer = document.getElementById('questions');
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `question-${index}`;
                if (index === 0) questionDiv.classList.add('active');

                questionDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-category">${q.category}</div>
                        <div class="question-number">Question ${q.id} of ${questions.length}</div>
                        <div class="question-text">${q.text}</div>
                    </div>
                    <div class="options-grid">
                        ${q.options.map((opt, optIndex) => `
                            <div class="option" onclick="selectOption(${index}, ${opt.value})">
                                <div class="option-radio"></div>
                                <div class="option-content">
                                    <div class="option-label">${opt.label}</div>
                                    <div class="option-description">${opt.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="navigation-buttons">
                        <button class="nav-btn btn-prev" onclick="previousQuestion()" ${index === 0 ? 'disabled' : ''}>
                            Previous
                        </button>
                        <button class="nav-btn btn-next" onclick="nextQuestion()" disabled>
                            ${index === questions.length - 1 ? 'See Results' : 'Next'}
                        </button>
                    </div>
                `;

                questionsContainer.appendChild(questionDiv);
                questionElements.push(questionDiv);
            });
        }

        function selectOption(questionIndex, value) {
            answers[questionIndex] = value;

            // Update UI
            const container = questionElements[questionIndex];
            const options = container.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
                opt.setAttribute('tabindex', '-1');
            });

            // Find the option with matching value (handles value=0 for "I don't know")
            const question = questions[questionIndex];
            const optionIndex = question.options.findIndex(opt => opt.value === value);

            if (optionIndex !== -1) {
                options[optionIndex].classList.add('selected');
                options[optionIndex].setAttribute('aria-checked', 'true');
                options[optionIndex].setAttribute('tabindex', '0');
                options[optionIndex].focus();
            }

            // Enable next button
            const nextBtn = container.querySelector('.btn-next');
            nextBtn.disabled = false;

            // Save progress
            saveProgress();
        }

        function restoreQuestionState(questionIndex) {
            // Rehydrate the selected option if an answer exists
            if (answers[questionIndex] !== undefined) {
                const container = questionElements[questionIndex];
                const options = container.querySelectorAll('.option');
                const value = answers[questionIndex];

                // Reset selection state for assistive tech
                options.forEach(opt => {
                    opt.classList.remove('selected');
                    opt.setAttribute('aria-checked', 'false');
                    opt.setAttribute('tabindex', '-1');
                });

                const selected = options[value - 1];
                if (selected) {
                    selected.classList.add('selected');
                    selected.setAttribute('aria-checked', 'true');
                    selected.setAttribute('tabindex', '0');
                }

                // Enable the next button
                const nextBtn = container.querySelector('.btn-next');
                if (nextBtn) nextBtn.disabled = false;
            }
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                questionElements[currentQuestion].classList.remove('active');
                currentQuestion++;
                questionElements[currentQuestion].classList.add('active');
                restoreQuestionState(currentQuestion);  // Restore state when navigating
                updateProgress();
            } else {
                showResults();
            }
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                questionElements[currentQuestion].classList.remove('active');
                currentQuestion--;
                questionElements[currentQuestion].classList.add('active');
                restoreQuestionState(currentQuestion);  // Restore state when navigating back
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        async function showResults() {
            // Completion guard: ensure all questions are answered
            const totalQuestions = questions.length;
            const answeredCount = Object.keys(answers).length;

            if (answeredCount < totalQuestions) {
                document.getElementById('incomplete-alert').style.display = 'block';
                document.getElementById('results').classList.add('active');
                return;
            } else {
                document.getElementById('incomplete-alert').style.display = 'none';
            }

            // Mark participant as completed in Supabase
            if (participantId) {
                try {
                    await supabase
                        .from('participants')
                        .update({ completed_at: new Date().toISOString() })
                        .eq('id', participantId);

                    // Update session status
                    await supabase
                        .from('assessment_sessions')
                        .update({
                            status: 'completed',
                            completed_at: new Date().toISOString()
                        })
                        .eq('id', sessionId);

                    console.log('Assessment completed and saved to Supabase');
                } catch (error) {
                    console.error('Error marking assessment complete:', error);
                }
            }

            // Hide questions, show results
            document.getElementById('questions').style.display = 'none';
            document.getElementById('results').classList.add('active');
            document.getElementById('progress').style.width = '100%';

            // Use DRY scoring function
            const { dimScores: dimensionScores, overall: overallScore, weights: dimensionWeights } = computeScores(answers);

            // Risk-aware gating logic (uses industry-specific threshold)
            const dataReadiness = dimensionScores['Data Readiness'] || 0;
            const governance = dimensionScores['Risk & Governance'] || 0;
            const highRisk = isHighRiskSelected();

            // Use industry-specific minFloor, boost to 60% minimum if high-risk selected
            const industryMinFloor = INTEGRATED_CONFIG[currentIndustry]?.assessment.minFloor || 40;
            const minFloor = highRisk ? Math.max(industryMinFloor, 60) : industryMinFloor;

            let maturityLevel;
            let gateTriggered = false;
            let gateMessage = '';

            if ((dataReadiness < minFloor || governance < minFloor) && overallScore >= 50) {
                maturityLevel = "AI Exploring"; // Cap label if critical gates not met
                gateTriggered = true;
                const failedGates = [];
                if (dataReadiness < minFloor) failedGates.push(`Data Readiness < ${minFloor}%`);
                if (governance < minFloor) failedGates.push(`Risk & Governance < ${minFloor}%`);
                gateMessage = `<svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-alert"/></svg>Gate: ${failedGates.join(', ')} ‚Üí Held at Exploring stage (high-risk=${highRisk ? 'yes' : 'no'})`;
            } else if (overallScore < 25) {
                maturityLevel = "AI Curious";
            } else if (overallScore < 50) {
                maturityLevel = "AI Exploring";
            } else if (overallScore < 75) {
                maturityLevel = "AI Ready";
            } else {
                maturityLevel = "AI Advanced";
            }

            // Show risk classifier for users to refine
            document.getElementById('risk-classifier').style.display = 'block';

            // Update UI
            document.getElementById('overall-score').textContent = overallScore + '%';
            document.getElementById('maturity-level').textContent = maturityLevel;

            // Display gate message if triggered
            const gateAlert = document.getElementById('gate-alert');
            if (gateTriggered) {
                gateAlert.innerHTML = `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 6px; margin: 1rem 0; color: #92400e;"><strong>${gateMessage}</strong><br><small>Critical dimensions must be ‚â•${minFloor}% to advance beyond Exploring${highRisk ? ' (high-risk classification active)' : ''}</small></div>`;
                gateAlert.style.display = 'block';
            } else {
                gateAlert.style.display = 'none';
            }

            // Calculate and display quantitative risk assessment
            const quantitativeRisk = calculateQuantitativeRisk(dimensionScores, highRisk);
            displayQuantitativeRisk(quantitativeRisk);

            // Display benchmark comparison
            displayBenchmark(overallScore);

            // Find lowest scoring dimension (bottleneck)
            let lowestDimension = null;
            let lowestScore = 100;
            for (const [dimension, score] of Object.entries(dimensionScores)) {
                if (score < lowestScore) {
                    lowestScore = score;
                    lowestDimension = dimension;
                }
            }

            // Display dimension scores
            const dimensionContainer = document.getElementById('dimension-scores');
            dimensionContainer.innerHTML = '';

            for (const [dimension, score] of Object.entries(dimensionScores)) {
                const color = score < 25 ? '#ef4444' :
                             score < 50 ? '#f59e0b' :
                             score < 75 ? '#10b981' : '#059669';

                const isBottleneck = dimension === lowestDimension;
                const bottleneckBadge = isBottleneck ? `<span style="background: #ef4444; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">BOTTLENECK</span>` : '';

                dimensionContainer.innerHTML += `
                    <div class="dimension-card" style="${isBottleneck ? 'border: 2px solid #ef4444;' : ''}">
                        <div class="dimension-name">${dimension}${bottleneckBadge}</div>
                        <div class="dimension-bar">
                            <div class="dimension-fill" style="width: ${score}%; background: ${color};"></div>
                        </div>
                        <div class="dimension-score">${Math.round(score)}%</div>
                    </div>
                `;
            }

            // Generate recommendations (including bottleneck-specific actions)
            const recommendations = generateRecommendations(overallScore, dimensionScores, lowestDimension);
            const recList = document.getElementById('recommendations');
            recList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');

            // Generate radar chart
            generateRadarChart(dimensionScores);

            // Generate roadmap
            generateRoadmap(overallScore, dimensionScores, maturityLevel);

            // Generate control gap register
            const controlGaps = generateControlGaps(dimensionScores);

            // Generate ISO 42001 Alignment Report
            generateISO42001Report(controlGaps);

            // Generate EU AI Act Compliance Checklist
            generateEUAIActChecklist(highRisk);

            // Generate AI System Card
            generateSystemCard(answers, dimensionScores, overallScore);

            // Populate executive readout for print
            populateExecutiveReadout(overallScore, maturityLevel, dimensionScores, gateTriggered, gateMessage);
        }

        function generateRecommendations(overall, dimensions, bottleneck) {
            const recs = [];

            // Add bottleneck-specific remediation at the top
            if (bottleneck) {
                const bottleneckActions = {
                    'Data Readiness': [
                        'Conduct data quality audit across key datasets',
                        'Implement data governance policies and ownership models',
                        'Invest in data cataloging and lineage tracking tools'
                    ],
                    'Risk & Governance': [
                        'Establish AI ethics committee and review process',
                        'Create incident response playbook for AI systems',
                        'Document decision rights and approval workflows'
                    ],
                    'Technical Capability': [
                        'Assess and upgrade ML infrastructure (compute, storage)',
                        'Upskill technical teams through training or hiring',
                        'Evaluate and select core AI/ML platforms and tools'
                    ],
                    'Business Alignment': [
                        'Define clear AI strategy with executive sponsorship',
                        'Create AI use case prioritization framework',
                        'Establish ROI tracking and value realization metrics'
                    ],
                    'Organizational Culture': [
                        'Launch AI literacy program for all employees',
                        'Create psychological safety for AI experimentation',
                        'Celebrate early wins and share learnings widely'
                    ]
                };

                const actions = bottleneckActions[bottleneck] || [];
                recs.push(`<strong><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-target"/></svg>Priority: Strengthen ${bottleneck} (your current bottleneck)</strong>`);
                actions.forEach(action => recs.push(action));
                recs.push(''); // Separator
            }

            if (overall < 25) {
                recs.push("Start with AI education: Schedule executive briefings to understand AI capabilities and limitations");
                recs.push("Focus on data foundation: Begin organizing and cleaning your most critical datasets");
                recs.push("Identify one simple use case: Pick a low-risk, high-visibility pilot project");
            } else if (overall < 50) {
                recs.push("Build a small AI task force: Assemble cross-functional team to explore opportunities");
                recs.push("Invest in data infrastructure: Prioritize data quality and accessibility improvements");
                recs.push("Run proof-of-concept projects: Test 2-3 use cases with clear success metrics");
            } else if (overall < 75) {
                recs.push("Scale successful pilots: Move proven use cases into production");
                recs.push("Develop AI governance: Create framework for ethical AI and risk management");
                recs.push("Invest in team capabilities: Hire or train dedicated AI/ML talent");
            } else {
                recs.push("Optimize and expand: Focus on scaling AI across the organization");
                recs.push("Share best practices: Become a center of excellence for AI adoption");
                recs.push("Explore cutting-edge applications: Consider advanced AI like generative models");
            }

            // Add dimension-specific recommendations
            const weakest = Object.entries(dimensions).sort((a, b) => a[1] - b[1])[0];
            if (weakest[1] < 50) {
                recs.push(`Priority focus area: Improve ${weakest[0]} (currently at ${Math.round(weakest[1])}%)`);
            }

            return recs;
        }

        function restartAssessment() {
            currentQuestion = 0;
            answers = {};

            // Clear persisted answers to honor privacy assurances
            try {
                localStorage.removeItem('ai_assessment_answers');
                sessionStorage.removeItem('assessment_session_id');
                sessionStorage.removeItem('assessment_participant_id');
            } catch (err) {
                console.warn('Failed to clear saved answers', err);
            }

            // Reset session IDs
            sessionId = null;
            participantId = null;
            organizationId = null;

            document.getElementById('results').classList.remove('active');
            document.getElementById('questions').style.display = 'block';

            // Reset all questions
            questionElements.forEach((el, index) => {
                el.classList.remove('active');
                if (index === 0) el.classList.add('active');

                // Clear selections
                const options = el.querySelectorAll('.option');
                options.forEach((opt, idx) => {
                    opt.classList.remove('selected');
                    opt.setAttribute('aria-checked', 'false');
                    opt.setAttribute('tabindex', idx === 0 ? '0' : '-1');
                });

                // Disable next button
                const nextBtn = el.querySelector('.btn-next');
                if (nextBtn) nextBtn.disabled = true;
            });

            updateProgress();
        }

        // Generate Radar Chart
        function generateRadarChart(dimensionScores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Object.keys(dimensionScores);
            const data = Object.values(dimensionScores);

            // Destroy existing chart to prevent memory leaks and visual stacking
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AI Readiness',
                        data: data,
                        backgroundColor: 'rgba(212, 165, 116, 0.2)',
                        borderColor: '#d4a574',
                        borderWidth: 2,
                        pointBackgroundColor: '#d4a574',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#d4a574'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Generate Roadmap
        function generateRoadmap(overallScore, dimensionScores, maturityLevel) {
            const roadmapContainer = document.getElementById('roadmap');

            const phases = [];

            if (overallScore < 50) {
                phases.push({
                    title: '0-90 Days: Foundation',
                    items: [
                        'Executive AI literacy program and briefing sessions',
                        'Data quality audit and cataloging initiative',
                        'Draft AI ethics and governance framework',
                        'Identify and prioritize 2-3 pilot use cases'
                    ]
                });
                phases.push({
                    title: '90-180 Days: Capability Building',
                    items: [
                        'Implement data quality improvements for pilot datasets',
                        'Establish AI governance committee and review processes',
                        'Launch first proof-of-concept with clear success metrics',
                        'Begin AI skills assessment and training plan'
                    ]
                });
                phases.push({
                    title: '180-270 Days: Pilot to Production',
                    items: [
                        'Deploy first production AI system with full monitoring',
                        'Establish model risk management and validation processes',
                        'Create AI platform strategy and vendor evaluation',
                        'Build executive sponsorship for scaled AI investment'
                    ]
                });
                phases.push({
                    title: '270-365 Days: Scale Readiness',
                    items: [
                        'Launch 2-3 additional use cases in production',
                        'Implement enterprise data governance framework',
                        'Establish AI Center of Excellence with dedicated team',
                        'Create multi-year AI transformation roadmap with business cases'
                    ]
                });
            } else if (overallScore < 75) {
                phases.push({
                    title: '0-90 Days: Scaling Foundations',
                    items: [
                        'Move successful pilots to production with monitoring',
                        'Implement AI risk management framework (aligned with NIST AI RMF)',
                        'Expand data infrastructure and MLOps capabilities',
                        'Create center of excellence for AI best practices'
                    ]
                });
                phases.push({
                    title: '90-180 Days: Enterprise Scaling',
                    items: [
                        'Deploy AI solutions across multiple business units',
                        'Establish model monitoring and incident response procedures',
                        'Implement comprehensive AI training program',
                        'Build AI strategy roadmap integrated with business objectives'
                    ]
                });
                phases.push({
                    title: '180-270 Days: Advanced Capabilities',
                    items: [
                        'Launch generative AI and advanced ML use cases',
                        'Implement automated model lifecycle management (MLOps)',
                        'Establish AI performance metrics and value realization tracking',
                        'Create AI partnership and vendor ecosystem strategy'
                    ]
                });
                phases.push({
                    title: '270-365 Days: Transformation at Scale',
                    items: [
                        'Deploy AI portfolio across all major business functions',
                        'Establish continuous compliance monitoring for AI regulations',
                        'Build AI-driven innovation pipeline with business alignment',
                        'Create industry thought leadership position in AI adoption'
                    ]
                });
            } else {
                phases.push({
                    title: '0-90 Days: Optimization',
                    items: [
                        'Conduct AI portfolio optimization and rationalization',
                        'Implement advanced MLOps with automated retraining',
                        'Establish AI innovation lab for emerging technologies',
                        'Create executive AI metrics dashboard and value tracking'
                    ]
                });
                phases.push({
                    title: '90-180 Days: Innovation Leadership',
                    items: [
                        'Explore cutting-edge AI applications (GenAI, multimodal AI)',
                        'Share best practices externally (thought leadership)',
                        'Develop AI partnerships and ecosystem strategy',
                        'Continuously refine governance for emerging AI capabilities'
                    ]
                });
                phases.push({
                    title: '180-270 Days: Market Differentiation',
                    items: [
                        'Launch AI-powered products and services to market',
                        'Establish AI R&D function for competitive advantage',
                        'Build strategic partnerships with AI technology leaders',
                        'Create IP strategy for proprietary AI capabilities'
                    ]
                });
                phases.push({
                    title: '270-365 Days: Industry Leadership',
                    items: [
                        'Position organization as AI innovation leader in industry',
                        'Monetize AI capabilities through new business models',
                        'Contribute to AI standards and regulatory frameworks',
                        'Build AI talent pipeline and academic partnerships'
                    ]
                });
            }

            roadmapContainer.innerHTML = `
                <h3>Implementation Roadmap</h3>
                ${phases.map(phase => `
                    <div class="roadmap-phase">
                        <h4>${phase.title}</h4>
                        <ul>
                            ${phase.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `).join('')}
            `;
        }

        // Generate Control Gap Register
        function generateControlGaps(dimensionScores) {
            const controlGapsContainer = document.getElementById('control-gaps');

            const controlGaps = [];

            // Map dimension scores to control gaps
            Object.entries(dimensionScores).forEach(([dimension, score]) => {
                questions.forEach(q => {
                    if (q.category === dimension) {
                        const answer = answers[questions.indexOf(q)];
                        if (answer && answer < 3) { // Flag controls where answer is below "good"
                            const severity = answer === 1 ? 'critical' : 'high';
                            controlGaps.push({
                                id: q.meta.control_id,
                                dimension: dimension,
                                description: q.text,
                                severity: severity,
                                nist: q.meta.nist,
                                iso: q.meta.iso_42001,
                                eu_ai_act: q.meta.eu_ai_act,
                                currentLevel: q.options[answer - 1].label,
                                recommendation: `Improve to at least "${q.options[2].label}" level`
                            });
                        }
                    }
                });
            });

            // Sort by severity
            controlGaps.sort((a, b) => {
                const severityOrder = { critical: 0, high: 1, medium: 2 };
                return severityOrder[a.severity] - severityOrder[b.severity];
            });

            controlGapsContainer.innerHTML = `
                <h3>Control Gap Register</h3>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">
                    Controls requiring attention based on your assessment responses. Each control is mapped to relevant standards and frameworks.
                </p>
                ${controlGaps.length === 0 ?
                    '<p style="color: #059669;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-check"/></svg>No critical control gaps identified. Continue monitoring and improving existing controls.</p>' :
                    controlGaps.map(gap => `
                        <div class="control-item ${gap.severity}">
                            <div class="control-header">
                                <span class="control-id">${gap.id}: ${gap.dimension}</span>
                                <span class="severity-badge ${gap.severity}">${gap.severity.toUpperCase()}</span>
                            </div>
                            <div class="control-description">
                                <strong>Control:</strong> ${gap.description}<br>
                                <strong>Current State:</strong> ${gap.currentLevel}<br>
                                <strong>Recommendation:</strong> ${gap.recommendation}<br>
                                <strong>Evidence to Collect:</strong><br>
                                ${(EVIDENCE_LIBRARY[gap.id] || ['Generic evidence documentation']).map(e => `&nbsp;&nbsp;‚Ä¢ ${e}`).join('<br>')}<br>
                                <strong>Standards:</strong> NIST ${gap.nist} | ISO/IEC 42001 ${gap.iso} | EU AI Act ${gap.eu_ai_act}
                            </div>
                        </div>
                    `).join('')
                }
            `;

            return controlGaps; // Return for use in ISO/EU reports
        }

        // Generate AI System Card
        function generateSystemCard(answers, dimensionScores, overallScore) {
            const systemCardContainer = document.getElementById('system-card');

            // Determine primary use cases based on answers
            const useCaseAnswer = questions[4].options[answers[4] - 1]?.label || 'Not defined';
            const governanceAnswer = questions[8].options[answers[8] - 1]?.label || 'Not established';
            const dataQualityAnswer = questions[1].options[answers[1] - 1]?.description || 'Unknown';

            systemCardContainer.innerHTML = `
                <h3>AI System Card (Draft)</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem;">
                    This draft system card provides transparency about your AI readiness based on Model Cards principles
                    <a href="https://arxiv.org/abs/1810.03993" target="_blank" style="color: #d4a574;">[Mitchell et al., 2018]</a>
                </p>

                <div class="system-card-section">
                    <h4>Purpose & Use Cases</h4>
                    <p><strong>Maturity Level:</strong> ${useCaseAnswer}</p>
                    <p>Organization is preparing AI systems for deployment with focus on defined business objectives and measurable outcomes.</p>
                </div>

                <div class="system-card-section">
                    <h4>Data Foundation</h4>
                    <p><strong>Data Infrastructure:</strong> ${dataQualityAnswer}</p>
                    <p><strong>Data Readiness Score:</strong> ${Math.round(dimensionScores['Data Readiness'])}%</p>
                    <p>Recommendation: ${dimensionScores['Data Readiness'] < 60 ? 'Prioritize data quality initiatives before production deployment' : 'Data foundation suitable for AI implementation'}</p>
                </div>

                <div class="system-card-section">
                    <h4>Risk Management & Oversight</h4>
                    <p><strong>Governance Status:</strong> ${governanceAnswer}</p>
                    <p><strong>Risk & Governance Score:</strong> ${Math.round(dimensionScores['Risk & Governance'])}%</p>
                    <p><strong>Framework Alignment:</strong> NIST AI RMF, ISO/IEC 42001, EU AI Act (risk-based approach)</p>
                </div>

                <div class="system-card-section">
                    <h4>Performance & Monitoring</h4>
                    <p><strong>Overall Readiness:</strong> ${overallScore}%</p>
                    <p><strong>Technical Capability:</strong> ${Math.round(dimensionScores['Technical Capability'])}%</p>
                    <p>Monitoring approach should include model performance tracking, bias detection, and incident response procedures.</p>
                </div>

                <div class="system-card-section">
                    <h4>Limitations & Recommendations</h4>
                    <p>This assessment provides directional guidance. Before production deployment:</p>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Conduct detailed technical due diligence</li>
                        <li>Validate data quality and representativeness</li>
                        <li>Establish comprehensive monitoring and governance</li>
                        <li>Ensure compliance with applicable regulations (GDPR, AI Act, sector-specific rules)</li>
                    </ul>
                </div>
            `;
        }

        // ISO 42001 Control Mapping
        const ISO_42001_MAPPING = {
            'DS-1': { clause: '7.4', title: 'Data for AI system', risk: 'Medium' },
            'DS-2': { clause: '7.4.3', title: 'Data quality management', risk: 'High' },
            'GOV-1': { clause: '5.1-5.3', title: 'AI management system leadership & policy', risk: 'Critical' },
            'GOV-2': { clause: '6.1', title: 'Risk management', risk: 'Critical' },
            'TC-1': { clause: '7.2', title: 'Competence', risk: 'Medium' },
            'TC-2': { clause: '7.3', title: 'Infrastructure', risk: 'Medium' },
            'BA-1': { clause: '4.1', title: 'Understanding the organization and its context', risk: 'Low' },
            'BA-2': { clause: '5.1', title: 'Leadership and commitment', risk: 'Medium' },
            'OC-1': { clause: '7.3', title: 'Awareness and communication', risk: 'Low' },
            'OC-2': { clause: '7.2', title: 'Competence and training', risk: 'Medium' }
        };

        // Generate ISO 42001 Alignment Report
        function generateISO42001Report(controlGaps) {
            const container = document.getElementById('iso-alignment-content');
            const reportEl = document.getElementById('iso-42001-report');

            if (controlGaps.length === 0) {
                container.innerHTML = '<p style="color: #10b981;">‚úÖ No significant gaps identified. Your organization demonstrates strong alignment with ISO 42001 requirements.</p>';
                reportEl.style.display = 'block';
                return;
            }

            // Group by risk level
            const critical = controlGaps.filter(g => ISO_42001_MAPPING[g.id]?.risk === 'Critical');
            const high = controlGaps.filter(g => ISO_42001_MAPPING[g.id]?.risk === 'High');
            const medium = controlGaps.filter(g => ISO_42001_MAPPING[g.id]?.risk === 'Medium');
            const low = controlGaps.filter(g => ISO_42001_MAPPING[g.id]?.risk === 'Low');

            const sections = [];

            if (critical.length > 0) {
                sections.push(`
                    <div style="border-left: 4px solid #dc2626; padding: 1rem; background: #fee2e2; margin-bottom: 1rem; border-radius: 4px;">
                        <h4 style="color: #dc2626; margin-bottom: 0.5rem;"><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-alert"/></svg>Critical Gaps (${critical.length})</h4>
                        <p style="font-size: 0.875rem; color: #991b1b; margin-bottom: 0.75rem;">Must be addressed before ISO 42001 certification</p>
                        ${critical.map(gap => `
                            <div style="background: white; padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px;">
                                <strong>Clause ${ISO_42001_MAPPING[gap.id].clause}:</strong> ${ISO_42001_MAPPING[gap.id].title}<br>
                                <span style="color: #6b7280; font-size: 0.875rem;">${gap.description}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            }

            if (high.length > 0) {
                sections.push(`
                    <div style="border-left: 4px solid #f59e0b; padding: 1rem; background: #fef3c7; margin-bottom: 1rem; border-radius: 4px;">
                        <h4 style="color: #f59e0b; margin-bottom: 0.5rem;">üü† High Priority Gaps (${high.length})</h4>
                        ${high.map(gap => `
                            <div style="background: white; padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px;">
                                <strong>Clause ${ISO_42001_MAPPING[gap.id].clause}:</strong> ${ISO_42001_MAPPING[gap.id].title}<br>
                                <span style="color: #6b7280; font-size: 0.875rem;">${gap.description}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            }

            if (medium.length > 0) {
                sections.push(`
                    <div style="border-left: 4px solid #eab308; padding: 1rem; background: #fef9c3; margin-bottom: 1rem; border-radius: 4px;">
                        <h4 style="color: #eab308; margin-bottom: 0.5rem;">üü° Medium Priority Gaps (${medium.length})</h4>
                        ${medium.map(gap => `
                            <div style="background: white; padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px;">
                                <strong>Clause ${ISO_42001_MAPPING[gap.id].clause}:</strong> ${ISO_42001_MAPPING[gap.id].title}<br>
                                <span style="color: #6b7280; font-size: 0.875rem;">${gap.description}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            }

            if (low.length > 0) {
                sections.push(`
                    <div style="border-left: 4px solid #10b981; padding: 1rem; background: #d1fae5; margin-bottom: 1rem; border-radius: 4px;">
                        <h4 style="color: #10b981; margin-bottom: 0.5rem;">üü¢ Low Priority Gaps (${low.length})</h4>
                        ${low.map(gap => `
                            <div style="background: white; padding: 0.75rem; margin: 0.5rem 0; border-radius: 4px;">
                                <strong>Clause ${ISO_42001_MAPPING[gap.id].clause}:</strong> ${ISO_42001_MAPPING[gap.id].title}<br>
                                <span style="color: #6b7280; font-size: 0.875rem;">${gap.description}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            }

            container.innerHTML = sections.join('') + `
                <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <strong>Certification Readiness:</strong> ${critical.length === 0 && high.length === 0 ? 'High - Ready for pre-assessment' : critical.length > 0 ? 'Low - Address critical gaps first' : 'Medium - Address high-priority gaps'}
                </div>
            `;
            reportEl.style.display = 'block';
        }

        // Generate EU AI Act Compliance Checklist
        function generateEUAIActChecklist(highRiskSelected) {
            const container = document.getElementById('eu-act-content');
            const reportEl = document.getElementById('eu-ai-act-checklist');

            if (!highRiskSelected) {
                container.innerHTML = '<p style="color: #6b7280;">No high-risk AI applications selected. EU AI Act obligations are limited for low-risk systems (transparency requirements only).</p>';
                reportEl.style.display = 'block';
                return;
            }

            const requirements = [
                { article: 'Art. 9', requirement: 'Risk management system', status: 'check', detail: 'Establish and maintain risk management throughout lifecycle' },
                { article: 'Art. 10', requirement: 'Data governance', status: 'check', detail: 'Ensure training/validation data quality, relevance, and representativeness' },
                { article: 'Art. 11', requirement: 'Technical documentation', status: 'check', detail: 'Maintain comprehensive technical documentation for authorities' },
                { article: 'Art. 12', requirement: 'Record-keeping (logs)', status: 'check', detail: 'Automatic recording of events (logging) for traceability' },
                { article: 'Art. 13', requirement: 'Transparency & information', status: 'check', detail: 'Provide clear information to users about AI system capabilities and limitations' },
                { article: 'Art. 14', requirement: 'Human oversight', status: 'check', detail: 'Design systems to enable effective human oversight and intervention' },
                { article: 'Art. 15', requirement: 'Accuracy, robustness, cybersecurity', status: 'check', detail: 'Achieve appropriate levels of accuracy and resilience against errors/attacks' },
                { article: 'Art. 16', requirement: 'Obligations of providers', status: 'pending', detail: 'Comply with obligations regarding conformity assessment and CE marking' },
                { article: 'Art. 17', requirement: 'Quality management system', status: 'pending', detail: 'Implement quality management system (e.g., ISO 42001 alignment)' },
                { article: 'Art. 61', requirement: 'Post-market monitoring', status: 'pending', detail: 'Establish post-market monitoring system and report serious incidents' }
            ];

            const checklistHtml = requirements.map(req => `
                <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin: 0.5rem 0;">
                    <div style="flex-shrink: 0; width: 24px; height: 24px; border: 2px solid ${req.status === 'check' ? '#10b981' : '#f59e0b'}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: ${req.status === 'check' ? '#10b981' : '#f59e0b'}; font-weight: bold;">
                        ${req.status === 'check' ? '<svg width="16" height="16"><use href="#icon-check"/></svg>' : '!'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${req.article}: ${req.requirement}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${req.detail}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
                    <strong><svg width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"><use href="#icon-alert"/></svg>High-Risk AI System Detected</strong><br>
                    <span style="font-size: 0.875rem; color: #92400e;">Your selected use cases trigger EU AI Act high-risk obligations. Compliance is mandatory before market deployment in EU.</span>
                </div>
                ${checklistHtml}
                <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <strong>Next Steps:</strong> Conduct detailed conformity assessment, prepare technical documentation, and establish quality management system aligned with Annex IV requirements.
                </div>
            `;
            reportEl.style.display = 'block';
        }

        // Calculate ROI from assessment gaps (INTEGRATION WITH ROI CALCULATOR)
        function calculateROIFromGaps() {
            const { dimScores, overall, weights } = computeScores(answers);
            const controlGaps = generateControlGaps(dimScores);
            const config = INTEGRATED_CONFIG[currentIndustry];

            if (!config) {
                alert('Please select an industry first to calculate ROI impact.');
                return;
            }

            // Calculate penalties from control gaps
            let totalAdditionalCost = 0;
            let totalTimelineExtension = 0;
            const gapDetails = [];

            controlGaps.forEach(gap => {
                const penalty = config.gapImpact[gap.id];
                if (penalty && (gap.severity === 'critical' || gap.severity === 'high')) {
                    totalAdditionalCost += penalty.cost;
                    totalTimelineExtension += penalty.months;
                    gapDetails.push({
                        control: gap.id,
                        description: gap.description,
                        cost: penalty.cost,
                        months: penalty.months,
                        impactNote: penalty.description
                    });
                }
            });

            // Calculate value unlock estimate (rough order of magnitude)
            const valueMultiplier = {
                'financial-services': 3.5,  // High ROI due to automation of expensive processes
                'healthcare': 4.0,          // Highest ROI from improved outcomes
                'public-sector': 2.0,       // Lower commercial ROI but high social value
                'retail': 3.0,              // Good ROI from personalization/efficiency
                'manufacturing': 3.5,       // Strong ROI from predictive maintenance
                'generic': 2.5
            };

            const potentialValue = totalAdditionalCost * (valueMultiplier[currentIndustry] || 2.5);
            const valueRange = {
                low: Math.round(potentialValue * 0.7 / 100000) / 10,  // In millions, rounded
                high: Math.round(potentialValue * 1.3 / 100000) / 10
            };

            // Package data for ROI calculator
            const roiData = {
                source: 'ai-assessment',
                timestamp: new Date().toISOString(),
                industry: currentIndustry,
                industryLabel: config.label,

                // Assessment results
                maturityScore: overall,
                dimensionScores: dimScores,
                controlGaps: gapDetails,

                // ROI assumptions from industry config
                baselineAssumptions: config.roi,

                // Gap penalties
                penalties: {
                    additionalCost: totalAdditionalCost,
                    timelineMonths: totalTimelineExtension,
                    description: `Based on ${controlGaps.filter(g => g.severity === 'critical' || g.severity === 'high').length} critical/high-severity gaps`
                },

                // Value estimate
                valueEstimate: {
                    potential: potentialValue,
                    rangeLow: valueRange.low,
                    rangeHigh: valueRange.high,
                    unit: 'million USD',
                    note: `Estimated value unlock from addressing control gaps in ${config.label}`
                }
            };

            // Store in sessionStorage for ROI calculator
            sessionStorage.setItem('assessment_to_roi', JSON.stringify(roiData));

            // Show confirmation and open ROI calculator
            const message = `
Assessment data prepared for ROI analysis:

‚Ä¢ Maturity Score: ${overall}%
‚Ä¢ Critical/High Gaps: ${controlGaps.filter(g => g.severity === 'critical' || g.severity === 'high').length}
‚Ä¢ Additional Implementation Cost: $${(totalAdditionalCost / 1000).toFixed(0)}K
‚Ä¢ Timeline Extension: +${totalTimelineExtension} months
‚Ä¢ Estimated Value Unlock: $${valueRange.low}M - $${valueRange.high}M

Opening ROI Calculator...
            `.trim();

            if (confirm(message + '\n\nProceed to ROI Calculator?')) {
                // Open ROI calculator in new tab
                window.open('roi-calculator-premium.html', '_blank');
            }
        }

        // Export to JSON
        function exportToJSON() {
            const { dimScores, overall, weights } = computeScores(answers);
            const highRisk = isHighRiskSelected();
            const minFloor = highRisk ? 60 : 40;
            const dataReadiness = dimScores['Data Readiness'] || 0;
            const governance = dimScores['Risk & Governance'] || 0;

            let maturityLevel;
            if ((dataReadiness < minFloor || governance < minFloor) && overall >= 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 25) {
                maturityLevel = "AI Curious";
            } else if (overall < 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 75) {
                maturityLevel = "AI Ready";
            } else {
                maturityLevel = "AI Advanced";
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                responses: answers,
                dimensions: dimScores,
                overallScore: overall,
                maturityLevel: maturityLevel,
                meta: {
                    weights: weights,
                    gating: {
                        floor_base: 40,
                        floor_high_risk: 60,
                        high_risk: highRisk,
                        high_risk_areas: Array.from(document.querySelectorAll('#risk-classifier input[name="risk"]:checked')).map(cb => cb.value)
                    }
                }
            };

            // Export as downloadable JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `ai-assessment-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Sanitize CSV cells to prevent formula injection
        function safeCsvCell(v) {
            const s = String(v ?? '');
            return /^[=+\-@]/.test(s) ? "'" + s : s;
        }

        // Export Control Gaps to CSV
        function exportControlGaps() {
            const { dimScores: dimensionScores } = computeScores(answers);
            const controlGaps = [];

            Object.entries(dimensionScores).forEach(([dimension, score]) => {
                questions.forEach(q => {
                    if (q.category === dimension) {
                        const answer = answers[questions.indexOf(q)];
                        if (answer && answer < 3) {
                            const severity = answer === 1 ? 'CRITICAL' : 'HIGH';
                            controlGaps.push({
                                control_id: q.meta.control_id,
                                dimension: dimension,
                                severity: severity,
                                description: q.text.replace(/,/g, ';'),
                                nist: q.meta.nist,
                                iso_42001: q.meta.iso_42001,
                                iso_23894: q.meta.iso_23894,
                                eu_ai_act: q.meta.eu_ai_act,
                                current_state: q.options[answer - 1].label,
                                recommendation: `Improve to at least "${q.options[2].label}" level`
                            });
                        }
                    }
                });
            });

            // Create CSV with formula injection protection
            const headers = ['Control ID', 'Dimension', 'Severity', 'Description', 'NIST', 'ISO 42001', 'ISO 23894', 'EU AI Act', 'Current State', 'Recommendation'];
            const csvContent = [
                headers.join(','),
                ...controlGaps.map(gap =>
                    [
                        safeCsvCell(gap.control_id),
                        safeCsvCell(gap.dimension),
                        safeCsvCell(gap.severity),
                        `"${safeCsvCell(gap.description)}"`,
                        safeCsvCell(gap.nist),
                        safeCsvCell(gap.iso_42001),
                        safeCsvCell(gap.iso_23894),
                        safeCsvCell(gap.eu_ai_act),
                        safeCsvCell(gap.current_state),
                        `"${safeCsvCell(gap.recommendation)}"`
                    ].join(',')
                )
            ].join('\n');

            // Download CSV
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
            const exportFileDefaultName = `ai-control-gaps-${new Date().toISOString().split('T')[0]}.csv`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Export Unified Excel Workbook (6 tabs)
        function exportUnifiedExcel() {
            const { dimScores, overall, weights } = computeScores(answers);
            const controlGaps = generateControlGaps(dimScores);
            const config = INTEGRATED_CONFIG[currentIndustry];
            const highRisk = isHighRiskSelected();
            const minFloor = config.assessment.minFloor || (highRisk ? 60 : 40);
            const dataReadiness = dimScores['Data Readiness'] || 0;
            const governance = dimScores['Risk & Governance'] || 0;

            // Determine maturity level
            let maturityLevel;
            if ((dataReadiness < minFloor || governance < minFloor) && overall >= 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 25) {
                maturityLevel = "AI Curious";
            } else if (overall < 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 75) {
                maturityLevel = "AI Ready";
            } else {
                maturityLevel = "AI Advanced";
            }

            // Get ROI data if available
            const roiDataRaw = sessionStorage.getItem('assessment_to_roi');
            const roiData = roiDataRaw ? JSON.parse(roiDataRaw) : null;

            // Create workbook
            const wb = XLSX.utils.book_new();

            // TAB 1: Executive Summary
            const execData = [
                ['AI READINESS ASSESSMENT - EXECUTIVE SUMMARY'],
                [''],
                ['Industry', config.label],
                ['Assessment Date', new Date().toLocaleDateString()],
                [''],
                ['OVERALL MATURITY'],
                ['Score', overall + '%'],
                ['Level', maturityLevel],
                [''],
                ['DIMENSION SCORES'],
                ...Object.entries(dimScores).map(([dim, score]) => [dim, score + '%']),
                [''],
                ['TOP CONTROL GAPS'],
                ['Control ID', 'Severity', 'Description', 'Impact'],
                ...controlGaps.slice(0, 5).map(gap => [
                    gap.id,
                    gap.severity.toUpperCase(),
                    gap.description,
                    config.gapImpact[gap.id]?.description || 'N/A'
                ]),
                [''],
                ['VALUE OPPORTUNITY'],
                ...(roiData ? [
                    ['Gap Remediation Cost', '$' + (roiData.penalties.additionalCost / 1000).toFixed(0) + 'K'],
                    ['Timeline Extension', '+' + roiData.penalties.timelineMonths + ' months'],
                    ['Potential Value Unlock', '$' + roiData.valueEstimate.rangeLow + 'M - $' + roiData.valueEstimate.rangeHigh + 'M']
                ] : [
                    ['ROI Analysis', 'Not yet calculated - click "Calculate Value" button']
                ])
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(execData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Executive Summary');

            // TAB 2: Assessment Results
            const assessData = [
                ['ASSESSMENT RESULTS - DETAILED'],
                [''],
                ['DIMENSION SCORES & WEIGHTS'],
                ['Dimension', 'Score (%)', 'Weight', 'Weighted Score'],
                ...Object.entries(dimScores).map(([dim, score]) => [
                    dim,
                    score,
                    weights[dim],
                    (score * weights[dim]).toFixed(2)
                ]),
                [''],
                ['OVERALL SCORE', overall + '%'],
                [''],
                ['INDUSTRY BENCHMARKS (' + config.label + ')'],
                ['Percentile', 'Score Range'],
                ['25th', config.assessment.benchmarks.p25 + '%'],
                ['50th (Median)', config.assessment.benchmarks.p50 + '%'],
                ['75th', config.assessment.benchmarks.p75 + '%'],
                ['90th', config.assessment.benchmarks.p90 + '%'],
                [''],
                ['RADAR CHART DATA'],
                ['Dimension', 'Your Score', 'Industry Median'],
                ...Object.entries(dimScores).map(([dim, score]) => [
                    dim,
                    score,
                    config.assessment.benchmarks.p50
                ])
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(assessData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Assessment Results');

            // TAB 3: Control Gap Register
            const gapData = [
                ['CONTROL GAP REGISTER'],
                [''],
                ['Control ID', 'Dimension', 'Severity', 'Description', 'NIST AI RMF', 'ISO 42001', 'ISO 23894', 'EU AI Act', 'Cost Impact', 'Timeline Impact', 'Remediation Notes'],
                ...controlGaps.map(gap => {
                    const impact = config.gapImpact[gap.id] || {};
                    const question = questions.find(q => q.meta?.control_id === gap.id);
                    return [
                        gap.id,
                        gap.dimension,
                        gap.severity.toUpperCase(),
                        gap.description,
                        question?.meta?.nist || 'N/A',
                        question?.meta?.iso_42001 || 'N/A',
                        question?.meta?.iso_23894 || 'N/A',
                        question?.meta?.eu_ai_act || 'N/A',
                        impact.cost ? '$' + (impact.cost / 1000).toFixed(0) + 'K' : 'N/A',
                        impact.months ? '+' + impact.months + ' months' : 'N/A',
                        impact.description || 'N/A'
                    ];
                })
            ];
            const ws3 = XLSX.utils.aoa_to_sheet(gapData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Control Gaps');

            // TAB 4: ROI Analysis (if available)
            const roiTabData = [
                ['ROI ANALYSIS'],
                [''],
                ...(roiData ? [
                    ['BASELINE ASSUMPTIONS'],
                    ['Average Salary', '$' + config.roi.avgSalary.toLocaleString()],
                    ['Platform Cost', '$' + config.roi.platformCost.toLocaleString()],
                    ['Annual Compliance Cost', '$' + config.roi.annualComplianceCost.toLocaleString()],
                    ['Implementation Timeline', config.roi.implementationMonths + ' months'],
                    [''],
                    ['GAP-DRIVEN PENALTIES'],
                    ['Additional Cost from Gaps', '$' + roiData.penalties.additionalCost.toLocaleString()],
                    ['Timeline Extension', '+' + roiData.penalties.timelineMonths + ' months'],
                    [''],
                    ['VALUE OPPORTUNITY'],
                    ['Potential Value Unlock', '$' + roiData.valueEstimate.rangeLow + 'M - $' + roiData.valueEstimate.rangeHigh + 'M'],
                    ['Industry Multiplier', ((roiData.valueEstimate.potential / roiData.penalties.additionalCost) || 0).toFixed(1) + 'x'],
                    [''],
                    ['GAP BREAKDOWN'],
                    ['Control', 'Cost', 'Months', 'Impact Description'],
                    ...roiData.controlGaps.map(gap => [
                        gap.control,
                        '$' + (gap.cost / 1000).toFixed(0) + 'K',
                        gap.months,
                        gap.impactNote
                    ])
                ] : [
                    ['STATUS', 'ROI calculation not yet performed'],
                    ['ACTION', 'Click "Calculate Value of Closing Gaps" button in the assessment tool'],
                    [''],
                    ['NOTE', 'ROI analysis integrates assessment gaps with financial impact modeling']
                ])
            ];
            const ws4 = XLSX.utils.aoa_to_sheet(roiTabData);
            XLSX.utils.book_append_sheet(wb, ws4, 'ROI Analysis');

            // TAB 5: Integrated Roadmap
            const roadmaps = generateRoadmaps(maturityLevel);
            const roadmapData = [
                ['INTEGRATED ROADMAP - ' + maturityLevel.toUpperCase()],
                [''],
                ['PHASE 1: DAYS 0-90 (FOUNDATION)'],
                ...roadmaps.phase1.map(item => [item]),
                [''],
                ['PHASE 2: DAYS 90-180 (IMPLEMENTATION)'],
                ...roadmaps.phase2.map(item => [item]),
                [''],
                ['PHASE 3: DAYS 180-270 (OPTIMIZATION)'],
                ...roadmaps.phase3.map(item => [item]),
                [''],
                ['PHASE 4: DAYS 270-365 (SCALING)'],
                ...roadmaps.phase4.map(item => [item]),
                [''],
                ['ROI MILESTONES'],
                ...(roiData ? [
                    ['Month 3', 'Complete gap remediation foundation'],
                    ['Month 6', 'Achieve compliance baselines'],
                    ['Month 9', 'Platform go-live and value realization begins'],
                    ['Month 12', 'Full value unlock: $' + roiData.valueEstimate.rangeLow + 'M - $' + roiData.valueEstimate.rangeHigh + 'M']
                ] : [
                    ['ROI milestones available after gap-to-value calculation']
                ])
            ];
            const ws5 = XLSX.utils.aoa_to_sheet(roadmapData);
            XLSX.utils.book_append_sheet(wb, ws5, 'Roadmap');

            // TAB 6: Assumptions & Methodology
            const methodData = [
                ['ASSUMPTIONS & METHODOLOGY'],
                [''],
                ['INDUSTRY CONFIGURATION: ' + config.label],
                [''],
                ['DIMENSION WEIGHTS'],
                ...Object.entries(config.assessment.weights).map(([dim, weight]) => [dim, (weight * 100) + '%']),
                [''],
                ['REGULATORY CONTEXT'],
                [config.assessment.regulatoryNote],
                [''],
                ['GATING RULES'],
                ['Minimum Floor (Standard)', '40%'],
                ['Minimum Floor (High Risk)', config.assessment.minFloor + '%'],
                ['Data Readiness & Governance', 'Must exceed floor to advance maturity'],
                [''],
                ['GAP COST ASSUMPTIONS'],
                ['Control ID', 'Cost Impact', 'Timeline Impact', 'Description'],
                ...Object.entries(config.gapImpact).map(([id, impact]) => [
                    id,
                    '$' + (impact.cost / 1000).toFixed(0) + 'K',
                    '+' + impact.months + ' months',
                    impact.description
                ]),
                [''],
                ['STANDARDS ALIGNMENT'],
                ['Framework', 'Version'],
                ['NIST AI RMF', '1.0 (January 2023)'],
                ['ISO/IEC 42001', '2023'],
                ['ISO/IEC 23894', '2023'],
                ['EU AI Act', '2024 (provisional)'],
                [''],
                ['RISK SCORING METHODOLOGY'],
                ['Formula', '(Technical Risk √ó Stakeholder Impact) √∑ Control Effectiveness'],
                ['Technical Risk', '100 - Technical Capability Score'],
                ['Stakeholder Impact', 'Base 30 (low risk) or 70 (high risk) + business alignment adjustment'],
                ['Control Effectiveness', 'Risk & Governance dimension score'],
                [''],
                ['EXPORT METADATA'],
                ['Generated', new Date().toISOString()],
                ['Assessment Version', '1.0'],
                ['Tool', 'AI Readiness Assessment (Premium)']
            ];
            const ws6 = XLSX.utils.aoa_to_sheet(methodData);
            XLSX.utils.book_append_sheet(wb, ws6, 'Methodology');

            // Download workbook
            const filename = `AI-Assessment-Complete-${currentIndustry}-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Export Board-Ready PowerPoint Presentation (10 slides)
        function exportToPowerPoint() {
            const { dimScores, overall, weights } = computeScores(answers);
            const controlGaps = generateControlGaps(dimScores);
            const config = INTEGRATED_CONFIG[currentIndustry];
            const highRisk = isHighRiskSelected();
            const minFloor = config.assessment.minFloor || (highRisk ? 60 : 40);
            const dataReadiness = dimScores['Data Readiness'] || 0;
            const governance = dimScores['Risk & Governance'] || 0;

            // Determine maturity level
            let maturityLevel;
            if ((dataReadiness < minFloor || governance < minFloor) && overall >= 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 25) {
                maturityLevel = "AI Curious";
            } else if (overall < 50) {
                maturityLevel = "AI Exploring";
            } else if (overall < 75) {
                maturityLevel = "AI Ready";
            } else {
                maturityLevel = "AI Advanced";
            }

            // Get risk assessment
            const riskAssessment = calculateQuantitativeRisk(dimScores, highRisk);
            const roadmaps = generateRoadmaps(maturityLevel);
            const roiDataRaw = sessionStorage.getItem('assessment_to_roi');
            const roiData = roiDataRaw ? JSON.parse(roiDataRaw) : null;

            // Create presentation
            const pptx = new PptxGenJS();

            // Define color scheme
            const colors = {
                primary: '2D3E50',
                accent: 'D4A574',
                success: '10B981',
                warning: 'F59E0B',
                danger: 'EF4444',
                text: '1F2937',
                lightBg: 'F3F4F6'
            };

            // SLIDE 1: Title / Executive Summary
            let slide1 = pptx.addSlide();
            slide1.background = { color: colors.primary };
            slide1.addText('AI Readiness Assessment', {
                x: 0.5, y: 1.5, w: 9, h: 1,
                fontSize: 44, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide1.addText('Board Executive Summary', {
                x: 0.5, y: 2.5, w: 9, h: 0.5,
                fontSize: 24, color: colors.accent, align: 'center'
            });
            slide1.addText([
                { text: 'Industry: ', options: { color: 'CCCCCC' } },
                { text: config.label, options: { color: 'FFFFFF', bold: true } }
            ], {
                x: 0.5, y: 4, w: 9, h: 0.4,
                fontSize: 18, align: 'center'
            });
            slide1.addText([
                { text: 'Maturity Score: ', options: { color: 'CCCCCC' } },
                { text: overall + '% (' + maturityLevel + ')', options: { color: colors.accent, bold: true } }
            ], {
                x: 0.5, y: 4.5, w: 9, h: 0.4,
                fontSize: 18, align: 'center'
            });
            slide1.addText(new Date().toLocaleDateString(), {
                x: 0.5, y: 6.5, w: 9, h: 0.3,
                fontSize: 12, color: '999999', align: 'center'
            });

            // SLIDE 2: Methodology
            let slide2 = pptx.addSlide();
            slide2.addText('Assessment Methodology', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });
            slide2.addText('Standards Alignment & Framework', {
                x: 0.5, y: 1, w: 9, h: 0.4,
                fontSize: 16, color: '666666'
            });

            const methodRows = [
                ['Framework', 'Version', 'Coverage'],
                ['NIST AI RMF', '1.0 (2023)', 'Risk Management'],
                ['ISO/IEC 42001', '2023', 'AI Management System'],
                ['ISO/IEC 23894', '2023', 'Risk Management'],
                ['EU AI Act', '2024 (Provisional)', 'Compliance & Ethics']
            ];
            slide2.addTable(methodRows, {
                x: 0.5, y: 1.8, w: 9, h: 2.5,
                colW: [3, 2, 4],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 14
            });

            slide2.addText('Industry Configuration: ' + config.label, {
                x: 0.5, y: 4.5, w: 9, h: 0.4,
                fontSize: 14, bold: true, color: colors.primary
            });
            slide2.addText(config.assessment.regulatoryNote, {
                x: 0.5, y: 5, w: 9, h: 0.8,
                fontSize: 12, color: '666666'
            });

            // SLIDE 3: Maturity Results
            let slide3 = pptx.addSlide();
            slide3.addText('Maturity Assessment Results', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            // Dimension scores table
            const dimRows = [
                ['Dimension', 'Score', 'Weight', 'Contribution'],
                ...Object.entries(dimScores).map(([dim, score]) => [
                    dim,
                    score + '%',
                    (weights[dim] * 100).toFixed(0) + '%',
                    (score * weights[dim]).toFixed(1)
                ])
            ];
            slide3.addTable(dimRows, {
                x: 0.5, y: 1.2, w: 6, h: 4,
                colW: [2.5, 1, 1, 1.5],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 12
            });

            // Overall score callout
            slide3.addShape(pptx.ShapeType.roundRect, {
                x: 7, y: 1.5, w: 2.5, h: 1.5,
                fill: { color: colors.accent },
                line: { type: 'none' }
            });
            slide3.addText('Overall Score', {
                x: 7, y: 1.7, w: 2.5, h: 0.4,
                fontSize: 14, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide3.addText(overall + '%', {
                x: 7, y: 2.2, w: 2.5, h: 0.7,
                fontSize: 36, bold: true, color: 'FFFFFF', align: 'center'
            });

            // Maturity level
            slide3.addText(maturityLevel, {
                x: 7, y: 3.3, w: 2.5, h: 0.5,
                fontSize: 16, bold: true, color: colors.primary, align: 'center'
            });

            // SLIDE 4: Quantitative Risk Assessment
            let slide4 = pptx.addSlide();
            slide4.addText('Quantitative Risk Assessment', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            const riskRows = [
                ['Risk Component', 'Value', 'Assessment'],
                ['Technical Risk', riskAssessment.technicalRisk.toFixed(1), '100 - Technical Capability'],
                ['Stakeholder Impact', riskAssessment.stakeholderImpact.toFixed(1), 'Business alignment adjusted'],
                ['Control Effectiveness', riskAssessment.controlEffectiveness.toFixed(1), 'Governance score'],
                ['Residual Risk Score', riskAssessment.residualRisk.toFixed(1), '(Tech √ó Impact) √∑ Controls']
            ];
            slide4.addTable(riskRows, {
                x: 0.5, y: 1.3, w: 6.5, h: 2.5,
                colW: [2.5, 1.5, 2.5],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 14
            });

            // Risk level indicator
            const riskColor = riskAssessment.residualRisk < 25 ? colors.success :
                             riskAssessment.residualRisk < 50 ? colors.warning :
                             riskAssessment.residualRisk < 75 ? 'F59E0B' : colors.danger;

            slide4.addShape(pptx.ShapeType.roundRect, {
                x: 7.3, y: 1.5, w: 2.2, h: 2,
                fill: { color: riskColor },
                line: { type: 'none' }
            });
            slide4.addText('Risk Level', {
                x: 7.3, y: 1.7, w: 2.2, h: 0.4,
                fontSize: 14, bold: true, color: 'FFFFFF', align: 'center'
            });
            slide4.addText(riskAssessment.riskLevel, {
                x: 7.3, y: 2.2, w: 2.2, h: 0.8,
                fontSize: 18, bold: true, color: 'FFFFFF', align: 'center'
            });

            slide4.addText('Formula: (Technical Risk √ó Stakeholder Impact) √∑ Control Effectiveness', {
                x: 0.5, y: 4.2, w: 9, h: 0.4,
                fontSize: 12, italic: true, color: '666666', align: 'center'
            });

            // SLIDE 5: Control Gap Analysis
            let slide5 = pptx.addSlide();
            slide5.addText('Control Gap Analysis', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            const topGaps = controlGaps.slice(0, 8);
            const gapRows = [
                ['ID', 'Severity', 'Description', 'Cost', 'Timeline'],
                ...topGaps.map(gap => {
                    const impact = config.gapImpact[gap.id] || {};
                    return [
                        gap.id,
                        gap.severity.toUpperCase(),
                        gap.description.substring(0, 45) + '...',
                        impact.cost ? '$' + (impact.cost/1000).toFixed(0) + 'K' : 'N/A',
                        impact.months ? '+' + impact.months + 'mo' : 'N/A'
                    ];
                })
            ];
            slide5.addTable(gapRows, {
                x: 0.3, y: 1.2, w: 9.4, h: 4.5,
                colW: [0.8, 1.2, 4.5, 1.2, 1.2],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 11
            });

            slide5.addText(`${controlGaps.length} total gaps identified | Top ${topGaps.length} shown`, {
                x: 0.5, y: 6, w: 9, h: 0.3,
                fontSize: 11, italic: true, color: '666666', align: 'center'
            });

            // SLIDE 6: Value Realization Opportunity
            let slide6 = pptx.addSlide();
            slide6.addText('Value Realization Opportunity', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            if (roiData) {
                slide6.addShape(pptx.ShapeType.roundRect, {
                    x: 1, y: 1.5, w: 8, h: 1.2,
                    fill: { color: colors.success },
                    line: { type: 'none' }
                });
                slide6.addText('Estimated Value Unlock', {
                    x: 1, y: 1.7, w: 8, h: 0.4,
                    fontSize: 18, bold: true, color: 'FFFFFF', align: 'center'
                });
                slide6.addText(`$${roiData.valueEstimate.rangeLow}M - $${roiData.valueEstimate.rangeHigh}M`, {
                    x: 1, y: 2.1, w: 8, h: 0.5,
                    fontSize: 32, bold: true, color: 'FFFFFF', align: 'center'
                });

                const valueRows = [
                    ['Component', 'Value'],
                    ['Gap Remediation Cost', '$' + (roiData.penalties.additionalCost / 1000).toFixed(0) + 'K'],
                    ['Timeline Extension', '+' + roiData.penalties.timelineMonths + ' months'],
                    ['Industry Multiplier', ((roiData.valueEstimate.potential / roiData.penalties.additionalCost) || 0).toFixed(1) + 'x'],
                    ['Platform Base Cost', '$' + (config.roi.platformCost / 1000).toFixed(0) + 'K'],
                    ['Implementation Timeline', config.roi.implementationMonths + ' months (base)']
                ];
                slide6.addTable(valueRows, {
                    x: 1.5, y: 3.2, w: 7, h: 2.5,
                    colW: [4, 3],
                    fill: { color: colors.lightBg },
                    border: { pt: 1, color: 'CCCCCC' },
                    fontSize: 14
                });
            } else {
                slide6.addText('ROI calculation not yet performed', {
                    x: 1, y: 2.5, w: 8, h: 0.6,
                    fontSize: 20, color: '666666', align: 'center'
                });
                slide6.addText('Click "Calculate Value of Closing Gaps" in the assessment tool to generate ROI analysis', {
                    x: 1, y: 3.3, w: 8, h: 0.8,
                    fontSize: 14, italic: true, color: '999999', align: 'center'
                });
            }

            // SLIDE 7: ROI Scenarios (if available)
            let slide7 = pptx.addSlide();
            slide7.addText('ROI Scenarios & Sensitivity', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            if (roiData) {
                const scenarioRows = [
                    ['Scenario', 'Assumptions', 'NPV Impact', 'Payback'],
                    ['Conservative', '-30% value realization', '$' + (roiData.valueEstimate.rangeLow * 0.7).toFixed(1) + 'M', '18 months'],
                    ['Base Case', 'As calculated', '$' + roiData.valueEstimate.rangeLow + 'M', '12 months'],
                    ['Optimistic', '+30% value realization', '$' + (roiData.valueEstimate.rangeHigh * 1.3).toFixed(1) + 'M', '9 months']
                ];
                slide7.addTable(scenarioRows, {
                    x: 0.8, y: 1.5, w: 8.4, h: 2,
                    colW: [2, 3, 2, 1.4],
                    fill: { color: colors.lightBg },
                    border: { pt: 1, color: 'CCCCCC' },
                    fontSize: 14
                });

                slide7.addText('Key Sensitivity Factors', {
                    x: 0.5, y: 4, w: 9, h: 0.4,
                    fontSize: 18, bold: true, color: colors.primary
                });
                const factors = [
                    '‚Ä¢ Gap remediation timeline (¬±2 months = ¬±15% value)',
                    '‚Ä¢ Platform adoption rate (70% baseline)',
                    '‚Ä¢ Compliance cost avoidance',
                    '‚Ä¢ Operational efficiency gains'
                ];
                slide7.addText(factors.join('\n'), {
                    x: 1, y: 4.6, w: 8, h: 1.5,
                    fontSize: 13, color: '333333'
                });
            } else {
                slide7.addText('Scenarios available after ROI calculation', {
                    x: 1, y: 2.5, w: 8, h: 0.6,
                    fontSize: 18, color: '666666', align: 'center'
                });
            }

            // SLIDE 8: Integrated Roadmap
            let slide8 = pptx.addSlide();
            slide8.addText('Integrated Roadmap', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            const roadmapData = [
                ['Phase', 'Timeline', 'Key Activities'],
                ['Foundation', 'Days 0-90', roadmaps.phase1.slice(0, 2).join('; ')],
                ['Implementation', 'Days 90-180', roadmaps.phase2.slice(0, 2).join('; ')],
                ['Optimization', 'Days 180-270', roadmaps.phase3.slice(0, 2).join('; ')],
                ['Scaling', 'Days 270-365', roadmaps.phase4.slice(0, 2).join('; ')]
            ];
            slide8.addTable(roadmapData, {
                x: 0.5, y: 1.3, w: 9, h: 3,
                colW: [1.5, 1.5, 6],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 12
            });

            if (roiData) {
                slide8.addText('Value Milestones', {
                    x: 0.5, y: 4.7, w: 9, h: 0.4,
                    fontSize: 16, bold: true, color: colors.accent
                });
                const milestones = [
                    'Month 3: Foundation complete | Month 6: Compliance baseline achieved',
                    'Month 9: Platform go-live | Month 12: Full value unlock ($' + roiData.valueEstimate.rangeLow + 'M - $' + roiData.valueEstimate.rangeHigh + 'M)'
                ];
                slide8.addText(milestones.join('\n'), {
                    x: 0.5, y: 5.2, w: 9, h: 0.8,
                    fontSize: 12, color: '333333'
                });
            }

            // SLIDE 9: Standards Compliance
            let slide9 = pptx.addSlide();
            slide9.addText('Standards Compliance Status', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            const complianceRows = [
                ['Framework', 'Current State', 'Target State', 'Gap'],
                ['NIST AI RMF', overall >= 70 ? 'Aligned' : 'Partial', 'Full Alignment', overall >= 70 ? 'Minimal' : 'Moderate'],
                ['ISO 42001', overall >= 75 ? 'Ready' : 'In Progress', 'Certified', overall >= 75 ? '1 audit cycle' : '2-3 cycles'],
                ['EU AI Act', overall >= 65 ? 'Compliant' : 'At Risk', 'Fully Compliant', overall >= 65 ? 'Documentation' : 'Significant'],
                ['Industry Standards', overall >= config.assessment.benchmarks.p50 ? 'Above Average' : 'Below Average', 'Top Quartile', 'See gap register']
            ];
            slide9.addTable(complianceRows, {
                x: 0.5, y: 1.3, w: 9, h: 2.5,
                colW: [2.5, 2, 2, 2.5],
                fill: { color: colors.lightBg },
                border: { pt: 1, color: 'CCCCCC' },
                fontSize: 13
            });

            slide9.addText(config.assessment.regulatoryNote, {
                x: 0.5, y: 4.2, w: 9, h: 0.8,
                fontSize: 12, italic: true, color: '666666'
            });

            // SLIDE 10: Next Steps
            let slide10 = pptx.addSlide();
            slide10.addText('Recommended Next Steps', {
                x: 0.5, y: 0.3, w: 9, h: 0.6,
                fontSize: 32, bold: true, color: colors.primary
            });

            const nextSteps = [
                '1. Review and prioritize control gap remediation',
                '2. Validate ROI assumptions with finance team',
                '3. Approve 90-day foundation phase budget',
                '4. Establish AI governance committee',
                '5. Initiate vendor evaluation (if applicable)',
                '6. Schedule follow-up assessment in 6 months'
            ];
            slide10.addText(nextSteps.join('\n\n'), {
                x: 1, y: 1.5, w: 8, h: 3,
                fontSize: 16, color: colors.text
            });

            slide10.addShape(pptx.ShapeType.roundRect, {
                x: 1.5, y: 5, w: 7, h: 0.8,
                fill: { color: colors.accent },
                line: { type: 'none' }
            });
            slide10.addText('Questions? Contact your AI strategy advisor', {
                x: 1.5, y: 5.15, w: 7, h: 0.5,
                fontSize: 16, bold: true, color: 'FFFFFF', align: 'center'
            });

            // Generate and download
            const filename = `AI-Assessment-Board-Deck-${currentIndustry}-${new Date().toISOString().split('T')[0]}.pptx`;
            pptx.writeFile({ fileName: filename });
        }

        // Populate Executive Readout (for print)
        function populateExecutiveReadout(overall, maturity, dimScores, gateTriggered, gateMsg) {
            document.getElementById('exec-overall').textContent = overall + '%';
            document.getElementById('exec-maturity').textContent = maturity;

            if (gateTriggered) {
                document.getElementById('exec-gates').innerHTML = `
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 6px; color: #92400e;">
                        ${gateMsg}
                    </div>
                `;
            }

            // Dimension scores
            const dimensionsHtml = Object.entries(dimScores).map(([dim, score]) => {
                const color = score < 40 ? '#ef4444' : score < 60 ? '#f59e0b' : '#10b981';
                return `<div style="margin: 0.5rem 0;"><strong>${dim}:</strong> <span style="color: ${color};">${Math.round(score)}%</span></div>`;
            }).join('');
            document.getElementById('exec-dimensions').innerHTML = dimensionsHtml;

            // Top gaps (from control gap logic)
            const { dimScores: dimensionScores } = computeScores(answers);
            const controlGaps = [];
            Object.entries(dimensionScores).forEach(([dimension, score]) => {
                questions.forEach(q => {
                    if (q.category === dimension) {
                        const answer = answers[questions.indexOf(q)];
                        if (answer && answer < 3) {
                            const severity = answer === 1 ? 'critical' : 'high';
                            controlGaps.push({
                                id: q.meta.control_id,
                                description: q.text,
                                severity: severity,
                                dimension: dimension
                            });
                        }
                    }
                });
            });
            controlGaps.sort((a, b) => {
                const severityOrder = { critical: 0, high: 1, medium: 2 };
                return severityOrder[a.severity] - severityOrder[b.severity];
            });

            const topGapsHtml = controlGaps.slice(0, 5).map(gap =>
                `<li><strong>${gap.id}:</strong> ${gap.description} (${gap.dimension})</li>`
            ).join('');
            document.getElementById('exec-top-gaps').innerHTML = topGapsHtml || '<li>No critical gaps identified</li>';

            // 90-day plan (extract from roadmap logic)
            const phase90Items = overall < 50
                ? ['Executive AI literacy program and briefing sessions', 'Data quality audit and cataloging initiative', 'Draft AI ethics and governance framework', 'Identify and prioritize 2-3 pilot use cases']
                : overall < 75
                ? ['Move successful pilots to production with monitoring', 'Implement AI risk management framework (aligned with NIST AI RMF)', 'Expand data infrastructure and MLOps capabilities', 'Create center of excellence for AI best practices']
                : ['Conduct AI portfolio optimization and rationalization', 'Implement advanced MLOps with automated retraining', 'Establish AI innovation lab for emerging technologies', 'Create executive AI metrics dashboard and value tracking'];

            document.getElementById('exec-90').innerHTML = phase90Items.map(item => `<li>${item}</li>`).join('');
        }

        // Multi-respondent aggregation
        document.getElementById('agg-input')?.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;

            const results = [];
            for (const f of files) {
                try {
                    results.push(JSON.parse(await f.text()));
                } catch (err) {
                    console.error('Failed to parse JSON:', err);
                }
            }

            if (!results.length) {
                alert('No valid JSON files loaded');
                return;
            }

            const dims = ["Data Readiness", "Technical Capability", "Business Alignment", "Organizational Culture", "Risk & Governance"];
            const matrix = dims.map(() => []);

            results.forEach(r => {
                dims.forEach((d, i) => {
                    if (r.dimensions?.[d] != null) matrix[i].push(r.dimensions[d]);
                });
            });

            const med = arr => {
                const s = [...arr].sort((a, b) => a - b);
                const n = s.length;
                return n ? (n % 2 ? s[(n - 1) / 2] : (s[n / 2 - 1] + s[n / 2]) / 2) : 0;
            };

            const iqr = arr => {
                if (!arr.length) return 0;
                const s = [...arr].sort((a, b) => a - b);
                const q1 = med(s.slice(0, Math.floor(s.length / 2)));
                const q3 = med(s.slice(Math.ceil(s.length / 2)));
                return Math.max(0, q3 - q1);
            };

            const medians = matrix.map(med);
            const spreads = matrix.map(iqr);

            document.getElementById('aggregate-output').style.display = 'block';
            const ctx = document.getElementById('radarConsensus').getContext('2d');

            // Destroy existing consensus chart to prevent memory leaks
            if (consensusChartInstance) {
                consensusChartInstance.destroy();
            }

            consensusChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dims,
                    datasets: [{
                        label: 'Median Score',
                        data: medians,
                        borderWidth: 2,
                        borderColor: '#2c3e50',
                        backgroundColor: 'rgba(44,62,80,0.15)',
                        pointBackgroundColor: '#2c3e50',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20 } } }
                }
            });

            const consensusText = dims.map((d, i) => `${d}: IQR=${Math.round(spreads[i])}%`).join(' | ');
            document.getElementById('consensus-notes').innerHTML = `
                <strong>Consensus Analysis (${results.length} respondents):</strong><br>
                ${consensusText}<br>
                <small>Lower IQR indicates higher agreement. IQR >20% suggests significant divergence in perceptions.</small>
            `;
        });

        // Initialize on page load
        loadProgress(); // Load saved answers
        initAssessment();
        enhanceAccessibility(); // Add keyboard navigation
        updateProgress();

        // Restore saved answers if present
        if (Object.keys(answers).length > 0) {
            Object.keys(answers).forEach(idx => {
                restoreQuestionState(parseInt(idx));
            });
        }
    </script>
</body>
</html>